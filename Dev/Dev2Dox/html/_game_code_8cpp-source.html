<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>GameCode: d:/Projects/GameCodev2.2/Source/GameCode.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.3 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">d:</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_000001.html">Projects</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_000002.html">GameCodev2.2</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_000003.html">Source</a></div>
<h1>GameCode.cpp</h1><a href="_game_code_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//========================================================================</span>
<a name="l00002"></a>00002 <span class="comment">// GameCode.cpp : Defines the entry point for the application.</span>
<a name="l00003"></a>00003 <span class="comment">//</span>
<a name="l00004"></a>00004 <span class="comment">// Part of the GameCode2 Application</span>
<a name="l00005"></a>00005 <span class="comment">//</span>
<a name="l00006"></a>00006 <span class="comment">// GameCode2 is the sample application that encapsulates much of the source code</span>
<a name="l00007"></a>00007 <span class="comment">// discussed in "Game Coding Complete - 2nd Edition" by Mike McShaffry, published by</span>
<a name="l00008"></a>00008 <span class="comment">// Paraglyph Press. ISBN: 1-932111-91-3</span>
<a name="l00009"></a>00009 <span class="comment">//</span>
<a name="l00010"></a>00010 <span class="comment">// If this source code has found it's way to you, and you think it has helped you</span>
<a name="l00011"></a>00011 <span class="comment">// in any way, do the author a favor and buy a new copy of the book - there are </span>
<a name="l00012"></a>00012 <span class="comment">// detailed explanations in it that compliment this code well. Buy a copy at Amazon.com</span>
<a name="l00013"></a>00013 <span class="comment">// by clicking here: http://www.amazon.com/exec/obidos/ASIN/1932111913/gamecodecompl-20/</span>
<a name="l00014"></a>00014 <span class="comment">//</span>
<a name="l00015"></a>00015 <span class="comment">// There's also a companion web site at http://www.mcshaffry.com/GameCode/portal.php</span>
<a name="l00016"></a>00016 <span class="comment">//</span>
<a name="l00017"></a>00017 <span class="comment">// (c) Copyright 2005 Michael L. McShaffry</span>
<a name="l00018"></a>00018 <span class="comment">//</span>
<a name="l00019"></a>00019 <span class="comment">// This work is licensed under the Creative Commons Attribution-ShareAlike License. </span>
<a name="l00020"></a>00020 <span class="comment">// To view a copy of this license, visit http://creativecommons.org/licenses/by-sa/1.0/ </span>
<a name="l00021"></a>00021 <span class="comment">// or send a letter to:</span>
<a name="l00022"></a>00022 <span class="comment">//      Creative Commons</span>
<a name="l00023"></a>00023 <span class="comment">//      559 Nathan Abbott Way</span>
<a name="l00024"></a>00024 <span class="comment">//      Stanford, California 94305, USA.</span>
<a name="l00025"></a>00025 <span class="comment">//</span>
<a name="l00026"></a>00026 <span class="comment">//========================================================================</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="comment">//========================================================================</span>
<a name="l00030"></a>00030 <span class="comment">// There are two classes implemented in this file:</span>
<a name="l00031"></a>00031 <span class="comment">//</span>
<a name="l00032"></a>00032 <span class="comment">// GameCodeApp - the main application class, encapsulates hooking everything</span>
<a name="l00033"></a>00033 <span class="comment">//               the game needs into the Windows operating system.</span>
<a name="l00034"></a>00034 <span class="comment">//</span>
<a name="l00035"></a>00035 <span class="comment">// BaseGame - the main game application, serious attempts are made to make</span>
<a name="l00036"></a>00036 <span class="comment">//            this class OS agnositic</span>
<a name="l00037"></a>00037 <span class="comment">//========================================================================</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="comment">//========================================================================</span>
<a name="l00041"></a>00041 <span class="comment">//  Content References in Game Coding Complete 2nd Edition</span>
<a name="l00042"></a>00042 <span class="comment">// </span>
<a name="l00043"></a>00043 <span class="comment">// class HumanView - Chapter 9, page 260</span>
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="preprocessor">#include "<a class="code" href="_game_code_std_8h.html">GameCodeStd.h</a>"</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;atlconv.h&gt;</span>
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="preprocessor">#include "Dbt.h"</span>                                                <span class="comment">// required for DBT_DEVICEREMOVECOMPLETE</span>
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="preprocessor">#include "<a class="code" href="_game_code_8h.html">GameCode.h</a>"</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include "<a class="code" href="_initialization_8h.html">MainLoop\Initialization.h</a>"</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include "<a class="code" href="_game_code_error_8h.html">DumbStuff\GameCodeError.h</a>"</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include "<a class="code" href="_c_math_8h.html">DumbStuff\CMath.h</a>"</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include "<a class="code" href="_string_8h.html">DumbStuff\String.h</a>"</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include "<a class="code" href="_res_cache2_8h.html">ResourceCache\ResCache2.h</a>"</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include "<a class="code" href="_mini_dump_8h.html">Debugging\MiniDump.h</a>"</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include "<a class="code" href="_font_8h.html">Graphics2D\Font.h</a>"</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include "<a class="code" href="_strings_8h.html">Lang\Strings.h</a>"</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include "<a class="code" href="_direct_sound_audio_8h.html">Audio\DirectSoundAudio.h</a>"</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include "<a class="code" href="_trigger_system_events_8h.html">TriggerSystem\TriggerSystemEvents.h</a>"</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include "<a class="code" href="_trigger_system_impl_8h.html">TriggerSystem\TriggerSystemImpl.h</a>"</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include "<a class="code" href="_network_8h.html">Network\Network.h</a>"</span>
<a name="l00066"></a>00066 
<a name="l00067"></a><a class="code" href="_game_code_8cpp.html#a0">00067</a> <span class="preprocessor">#define MAX_LOADSTRING 100</span>
<a name="l00068"></a>00068 <span class="preprocessor"></span>
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 
<a name="l00072"></a><a class="code" href="_game_code_8h.html#a3">00072</a> <a class="code" href="class_game_code_app.html">GameCodeApp</a> *<a class="code" href="_game_code_8cpp.html#a1">g_pApp</a> = NULL;
<a name="l00073"></a>00073 
<a name="l00074"></a>00074 
<a name="l00075"></a>00075 <span class="comment">//========================================================================</span>
<a name="l00076"></a>00076 <span class="comment">//</span>
<a name="l00077"></a>00077 <span class="comment">// GameCodeApp implementation</span>
<a name="l00078"></a>00078 <span class="comment">//</span>
<a name="l00079"></a>00079 <span class="comment">//========================================================================</span>
<a name="l00080"></a>00080 
<a name="l00081"></a><a class="code" href="class_game_code_app.html#a0">00081</a> <a class="code" href="class_game_code_app.html#a0">GameCodeApp::GameCodeApp</a>()
<a name="l00082"></a>00082 {
<a name="l00083"></a>00083         g_pApp = <span class="keyword">this</span>;
<a name="l00084"></a>00084         <a class="code" href="class_game_code_app.html#o1">m_pGame</a> = NULL;
<a name="l00085"></a>00085 
<a name="l00086"></a>00086         <a class="code" href="class_game_code_app.html#p5">m_rcWindow</a>.bottom = <a class="code" href="class_game_code_app.html#p5">m_rcWindow</a>.left = <a class="code" href="class_game_code_app.html#p5">m_rcWindow</a>.right = <a class="code" href="class_game_code_app.html#p5">m_rcWindow</a>.top = 0;
<a name="l00087"></a>00087         <a class="code" href="class_game_code_app.html#p6">m_rcDesktop</a>.bottom = <a class="code" href="class_game_code_app.html#p6">m_rcDesktop</a>.left = <a class="code" href="class_game_code_app.html#p6">m_rcDesktop</a>.right = <a class="code" href="class_game_code_app.html#p6">m_rcDesktop</a>.top = 0;
<a name="l00088"></a>00088         <a class="code" href="class_game_code_app.html#p7">m_iColorDepth</a> = 32;
<a name="l00089"></a>00089 
<a name="l00090"></a>00090         <a class="code" href="class_game_code_app.html#o5">m_pEventManager</a> = NULL;
<a name="l00091"></a>00091         <a class="code" href="class_game_code_app.html#o3">m_ResCache</a> = NULL;
<a name="l00092"></a>00092 
<a name="l00093"></a>00093         <a class="code" href="class_game_code_app.html#p3">m_bQuitRequested</a> = <span class="keyword">false</span>;
<a name="l00094"></a>00094         <a class="code" href="class_game_code_app.html#p4">m_bQuitting</a> = <span class="keyword">false</span>;
<a name="l00095"></a>00095         <a class="code" href="class_game_code_app.html#p10">m_HasModalDialog</a> = 0;
<a name="l00096"></a>00096 }
<a name="l00097"></a>00097 
<a name="l00098"></a>00098 
<a name="l00099"></a><a class="code" href="class_game_code_app.html#a4">00099</a> <a class="code" href="_d_x_u_tgui_8cpp.html#a53">HWND</a> <a class="code" href="class_game_code_app.html#a4">GameCodeApp::GetHwnd</a>()
<a name="l00100"></a>00100 { 
<a name="l00101"></a>00101         <span class="keywordflow">return</span> <a class="code" href="_d_x_u_t_8cpp.html#a98">DXUTGetHWND</a>();
<a name="l00102"></a>00102 }
<a name="l00103"></a>00103 
<a name="l00104"></a>00104 
<a name="l00105"></a>00105 <span class="comment">//===================================================================</span>
<a name="l00106"></a>00106 <span class="comment">// Win32 Specific Stuff</span>
<a name="l00107"></a>00107 <span class="comment">//</span>
<a name="l00108"></a>00108 <span class="comment">// InitInstance - this checks system resources, creates your window, and launches the game</span>
<a name="l00109"></a>00109 <span class="comment">//</span>
<a name="l00110"></a>00110 <span class="comment">// preprocessor macro setting in the C++ options of the project provides the base macro</span>
<a name="l00111"></a>00111 <span class="comment">// C preprocessor string concatenation takes care of the rest.</span>
<a name="l00112"></a>00112 <span class="comment">//</span>
<a name="l00113"></a>00113 <span class="comment">// GameCodeApp::InitInstance - Chapter 5 - page 129</span>
<a name="l00114"></a>00114 <span class="comment">//</span>
<a name="l00115"></a>00115 <span class="comment">//===================================================================</span>
<a name="l00116"></a><a class="code" href="_game_code_8cpp.html#a2">00116</a> <span class="keywordtype">char</span> <span class="keyword">const</span> * <span class="keyword">const</span> <a class="code" href="_game_code_8cpp.html#a2">kpLangDllName</a> = <span class="stringliteral">"Lang"</span> APP_SUFX <span class="stringliteral">".dll"</span>;
<a name="l00117"></a>00117 
<a name="l00118"></a><a class="code" href="class_game_code_app.html#a6">00118</a> <span class="keywordtype">bool</span> <a class="code" href="class_game_code_app.html#a6">GameCodeApp::InitInstance</a>(HINSTANCE hInstance, LPTSTR lpCmdLine)
<a name="l00119"></a>00119 {
<a name="l00120"></a>00120         <span class="comment">// Check for existing instance of the same window</span>
<a name="l00121"></a>00121         <span class="comment">// </span>
<a name="l00122"></a>00122         <span class="comment">// NOTE: This is different than the book - it turns out that</span>
<a name="l00123"></a>00123         <span class="comment">// performing this test first is a REALLY good idea. Any init</span>
<a name="l00124"></a>00124         <span class="comment">// work you do before this could be done multiple times by multiple</span>
<a name="l00125"></a>00125         <span class="comment">// applications.</span>
<a name="l00126"></a>00126 
<a name="l00127"></a>00127 <span class="preprocessor">#ifndef _DEBUG</span>
<a name="l00128"></a>00128 <span class="preprocessor"></span>        <span class="comment">// Note - it can be really useful to debug network code to have</span>
<a name="l00129"></a>00129         <span class="comment">// more than one instance of the game up at one time - so</span>
<a name="l00130"></a>00130         <span class="comment">// feel free to comment these lines in or out as you wish!</span>
<a name="l00131"></a>00131         <span class="keywordflow">if</span> (!<a class="code" href="_initialization_8cpp.html#a3">IsOnlyInstance</a>(<a class="code" href="class_game_code_app.html#a1">VGetGameTitle</a>()))
<a name="l00132"></a>00132                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00133"></a>00133 <span class="preprocessor">#endif</span>
<a name="l00134"></a>00134 <span class="preprocessor"></span>
<a name="l00135"></a>00135         <span class="comment">// We don't need a mouse cursor by default, let the game turn it on</span>
<a name="l00136"></a>00136         SetCursor( NULL );
<a name="l00137"></a>00137 
<a name="l00138"></a>00138         <span class="comment">// Load the string table from the language resource dll</span>
<a name="l00139"></a>00139         <span class="comment">// Note: Only load it from same dir as exe ...</span>
<a name="l00140"></a>00140         <span class="keywordtype">char</span> appPath[MAX_PATH+1] = {0};
<a name="l00141"></a>00141 
<a name="l00142"></a>00142         memset( appPath, 0, <span class="keyword">sizeof</span>(appPath) );
<a name="l00143"></a>00143         
<a name="l00144"></a>00144         GetModuleFileNameA( NULL, appPath, MAX_PATH );
<a name="l00145"></a>00145         
<a name="l00146"></a>00146         <span class="keywordtype">char</span> <span class="keyword">const</span> * pSep = strrchr( appPath, _T(<span class="charliteral">'\\'</span>) );
<a name="l00147"></a>00147         
<a name="l00148"></a>00148         <span class="keywordflow">if</span> ( pSep == NULL )
<a name="l00149"></a>00149                 strcpy( appPath, <a class="code" href="_game_code_8cpp.html#a2">kpLangDllName</a> );
<a name="l00150"></a>00150         <span class="keywordflow">else</span>
<a name="l00151"></a>00151                 strcpy( appPath + (pSep - appPath) + 1, <a class="code" href="_game_code_8cpp.html#a2">kpLangDllName</a> );
<a name="l00152"></a>00152 
<a name="l00153"></a>00153         <a class="code" href="class_game_code_app.html#p8">m_LangDll</a> = LoadLibraryA(appPath);
<a name="l00154"></a>00154 
<a name="l00155"></a>00155         <span class="keywordflow">if</span> (!<a class="code" href="class_game_code_app.html#p8">m_LangDll</a>)
<a name="l00156"></a>00156         {
<a name="l00157"></a>00157                 TCHAR msg[4096];
<a name="l00158"></a>00158 
<a name="l00159"></a>00159                 _stprintf( msg, _T(<span class="stringliteral">"Error 6502: Language DLL not found ( %s ).\r\n\r\nPlease reinstall from your original CD."</span>), <a class="code" href="_game_code_8cpp.html#a2">kpLangDllName</a> );
<a name="l00160"></a>00160 
<a name="l00161"></a>00161                 MessageBox(NULL, msg, _T(<span class="stringliteral">"Error 6502"</span>), MB_OK);
<a name="l00162"></a>00162 
<a name="l00163"></a>00163                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00164"></a>00164         }
<a name="l00165"></a>00165 
<a name="l00166"></a>00166         <span class="comment">// Check for adequate machine resources.</span>
<a name="l00167"></a>00167         <span class="keywordtype">bool</span> resourceCheck = <span class="keyword">false</span>;
<a name="l00168"></a>00168         <span class="keywordflow">while</span> (!resourceCheck)
<a name="l00169"></a>00169         {
<a name="l00170"></a>00170                 <span class="keywordflow">try</span> 
<a name="l00171"></a>00171                 {
<a name="l00172"></a>00172                         <span class="keyword">const</span> <a class="code" href="_d_x_u_tgui_8cpp.html#a38">DWORD</a> physicalRAM = 32 * <a class="code" href="_game_code_std_8h.html#a7">MEGABYTE</a>;
<a name="l00173"></a>00173                         <span class="keyword">const</span> <a class="code" href="_d_x_u_tgui_8cpp.html#a38">DWORD</a> virtualRAM = 64 * <a class="code" href="_game_code_std_8h.html#a7">MEGABYTE</a>;
<a name="l00174"></a>00174                         <a class="code" href="_initialization_8cpp.html#a1">CheckMemory</a>(physicalRAM, virtualRAM);
<a name="l00175"></a>00175 
<a name="l00176"></a>00176                         <span class="keyword">const</span> <span class="keywordtype">int</span> diskSpace = 10 * <a class="code" href="_game_code_std_8h.html#a7">MEGABYTE</a>;
<a name="l00177"></a>00177                         <a class="code" href="_initialization_8cpp.html#a0">CheckHardDisk</a>(diskSpace);
<a name="l00178"></a>00178 
<a name="l00179"></a>00179                         <span class="keyword">const</span> <span class="keywordtype">int</span> minCpuSpeed = 266;
<a name="l00180"></a>00180                         <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="_c_p_u_speed_8cpp.html#a8">GetCPUSpeed</a>();
<a name="l00181"></a>00181                         <span class="keywordtype">int</span> thisCPU = <a class="code" href="_c_p_u_speed_8cpp.html#a8">GetCPUSpeed</a>();
<a name="l00182"></a>00182                         <span class="keywordflow">if</span> (thisCPU &lt; minCpuSpeed)
<a name="l00183"></a>00183                                 <span class="keywordflow">throw</span> <a class="code" href="class_game_code_error.html">GameCodeError</a>(<a class="code" href="_game_code_error_8h.html#a1">GCERR_INIT_CPU_TOO_SLOW</a>);
<a name="l00184"></a>00184 
<a name="l00185"></a>00185                         <span class="comment">// check DirectX version</span>
<a name="l00186"></a>00186 
<a name="l00187"></a>00187                         <span class="comment">// vram</span>
<a name="l00188"></a>00188                         <span class="comment">// const int vram = 4 * MEGABYTES;</span>
<a name="l00189"></a>00189                         <span class="comment">// CheckVRAM(vram);</span>
<a name="l00190"></a>00190                 }
<a name="l00191"></a>00191         
<a name="l00192"></a>00192                 <span class="keywordflow">catch</span> (<a class="code" href="class_game_code_error.html">GameCodeError</a> err)
<a name="l00193"></a>00193                 {
<a name="l00194"></a>00194                         <span class="keywordflow">if</span> (err.<a class="code" href="class_game_code_error.html#a1">Handle</a>()==ERROR_RETRY)
<a name="l00195"></a>00195                                 <span class="keywordflow">continue</span>;
<a name="l00196"></a>00196                         <span class="keywordflow">else</span>
<a name="l00197"></a>00197                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00198"></a>00198                 }
<a name="l00199"></a>00199 
<a name="l00200"></a>00200                 resourceCheck = <span class="keyword">true</span>;
<a name="l00201"></a>00201         }
<a name="l00202"></a>00202 
<a name="l00203"></a>00203         <a class="code" href="class_game_code_app.html#p0">m_hInstance</a> = hInstance;
<a name="l00204"></a>00204 
<a name="l00205"></a>00205         <a class="code" href="class_game_code_app.html#o2">m_pOptions</a> = <a class="code" href="_game_code_std_8h.html#a2">GCC_NEW</a> <a class="code" href="struct_game_options.html">GameOptions</a>(<span class="stringliteral">"m_pOptions-&gt;ini"</span>);
<a name="l00206"></a>00206         <a class="code" href="class_game_code_app.html#a7">ParseCommandLine</a>(lpCmdLine);
<a name="l00207"></a>00207 
<a name="l00208"></a>00208         <span class="comment">// event manager should be created first so that subsystems</span>
<a name="l00209"></a>00209         <span class="comment">// can hook in as desired.</span>
<a name="l00210"></a>00210         
<a name="l00211"></a>00211         <a class="code" href="class_game_code_app.html#o5">m_pEventManager</a> = <a class="code" href="_game_code_std_8h.html#a2">GCC_NEW</a> <a class="code" href="class_event_manager.html">EventManager</a>(<span class="stringliteral">"GameCodeApp Event Mgr"</span>, <span class="keyword">true</span> );
<a name="l00212"></a>00212         <span class="keywordflow">if</span> (!<a class="code" href="class_game_code_app.html#o5">m_pEventManager</a>)
<a name="l00213"></a>00213         {
<a name="l00214"></a>00214                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00215"></a>00215         }
<a name="l00216"></a>00216 
<a name="l00217"></a>00217         <span class="keywordflow">if</span> (!<a class="code" href="class_game_code_app.html#o2">m_pOptions</a>-&gt;<a class="code" href="struct_game_options.html#o12">m_gameHost</a>.empty())
<a name="l00218"></a>00218         {
<a name="l00219"></a>00219                 <a class="code" href="class_client_socket_manager.html">ClientSocketManager</a> *pClient = <a class="code" href="_game_code_std_8h.html#a2">GCC_NEW</a> <a class="code" href="class_client_socket_manager.html">ClientSocketManager</a>(<a class="code" href="class_game_code_app.html#o2">m_pOptions</a>-&gt;<a class="code" href="struct_game_options.html#o12">m_gameHost</a>, <a class="code" href="class_game_code_app.html#o2">m_pOptions</a>-&gt;<a class="code" href="struct_game_options.html#o11">m_listenPort</a>);
<a name="l00220"></a>00220                 <span class="keywordflow">if</span> (!pClient-&gt;<a class="code" href="class_client_socket_manager.html#a1">Connect</a>())
<a name="l00221"></a>00221                 {
<a name="l00222"></a>00222                         assert(0 &amp;&amp; _T(<span class="stringliteral">"Couldn't attach to game server."</span>));
<a name="l00223"></a>00223                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00224"></a>00224                 }
<a name="l00225"></a>00225                 <a class="code" href="class_game_code_app.html#o6">m_pBaseSocketManager</a> = pClient;
<a name="l00226"></a>00226         }
<a name="l00227"></a>00227         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_game_code_app.html#o2">m_pOptions</a>-&gt;<a class="code" href="struct_game_options.html#o11">m_listenPort</a> != -1)
<a name="l00228"></a>00228         {
<a name="l00229"></a>00229                 <a class="code" href="class_base_socket_manager.html">BaseSocketManager</a> *pServer = <a class="code" href="_game_code_std_8h.html#a2">GCC_NEW</a> <a class="code" href="class_base_socket_manager.html">BaseSocketManager</a>();
<a name="l00230"></a>00230                 <span class="keywordflow">if</span> (!pServer-&gt;<a class="code" href="class_base_socket_manager.html#a3">Init</a>())
<a name="l00231"></a>00231                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00232"></a>00232 
<a name="l00233"></a>00233                 pServer-&gt;<a class="code" href="class_base_socket_manager.html#a6">AddSocket</a>(<span class="keyword">new</span> <a class="code" href="class_game_server_listen_socket.html">GameServerListenSocket</a>(<a class="code" href="class_game_code_app.html#o2">m_pOptions</a>-&gt;<a class="code" href="struct_game_options.html#o11">m_listenPort</a>));
<a name="l00234"></a>00234                 <a class="code" href="class_game_code_app.html#o6">m_pBaseSocketManager</a> = pServer;
<a name="l00235"></a>00235         }
<a name="l00236"></a>00236 
<a name="l00237"></a>00237 
<a name="l00238"></a>00238         <span class="comment">//</span>
<a name="l00239"></a>00239         <span class="comment">// Initialize the ResCache - Chapter 5 - page 144</span>
<a name="l00240"></a>00240         <span class="comment">//</span>
<a name="l00241"></a>00241         <a class="code" href="class_game_code_app.html#o3">m_ResCache</a> = <a class="code" href="_game_code_std_8h.html#a2">GCC_NEW</a> <a class="code" href="class_res_cache.html">ResCache</a>(3, <a class="code" href="_game_code_std_8h.html#a2">GCC_NEW</a> <a class="code" href="class_resource_zip_file.html">ResourceZipFile</a>(_T(<span class="stringliteral">"data\\GameCode2.zip"</span>)));
<a name="l00242"></a>00242         <span class="keywordflow">if</span> (!<a class="code" href="class_game_code_app.html#o3">m_ResCache</a>-&gt;<a class="code" href="class_res_cache.html#a2">Init</a>())
<a name="l00243"></a>00243         {
<a name="l00244"></a>00244                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00245"></a>00245         }
<a name="l00246"></a>00246 
<a name="l00247"></a>00247     <span class="comment">// Initialize the sample framework and create the desired Win32 window and Direct3D </span>
<a name="l00248"></a>00248     <span class="comment">// device for the application. Calling each of these functions is optional, but they</span>
<a name="l00249"></a>00249     <span class="comment">// allow you to set several options which control the behavior of the framework.</span>
<a name="l00250"></a>00250         <span class="comment">//</span>
<a name="l00251"></a>00251         <span class="comment">// DXUTInit, DXUTCreateWindow - Chapter 5 - page 144</span>
<a name="l00252"></a>00252         
<a name="l00253"></a>00253         <a class="code" href="class_game_code_app.html#o0">m_pDialogResourceManager</a> = <a class="code" href="_game_code_std_8h.html#a2">GCC_NEW</a> <a class="code" href="class_c_d_x_u_t_dialog_resource_manager.html">CDXUTDialogResourceManager</a>();
<a name="l00254"></a>00254         <a class="code" href="_d_x_u_t_8cpp.html#a75">DXUTInit</a>( <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span> ); <span class="comment">// Parse the command line, handle the default hotkeys, and show msgboxes</span>
<a name="l00255"></a>00255 
<a name="l00256"></a>00256         <span class="comment">// Change 02-20-2006 - MLM </span>
<a name="l00257"></a>00257         <span class="comment">//   Resources were moved from GameCode library to TeapotWars</span>
<a name="l00258"></a>00258         <span class="comment">//   And new virtuals added to grab resources from inherited </span>
<a name="l00259"></a>00259         <span class="comment">//   application object.</span>
<a name="l00260"></a>00260 
<a name="l00261"></a>00261         HICON icon = <a class="code" href="class_game_code_app.html#a3">VGetIcon</a>();
<a name="l00262"></a>00262     <a class="code" href="_d_x_u_t_8cpp.html#a76">DXUTCreateWindow</a>( <a class="code" href="class_game_code_app.html#a1">VGetGameTitle</a>(), hInstance, icon );
<a name="l00263"></a>00263         <span class="keywordflow">if</span> (!<a class="code" href="class_game_code_app.html#a4">GetHwnd</a>())
<a name="l00264"></a>00264         {
<a name="l00265"></a>00265                 <span class="keywordflow">return</span> FALSE;
<a name="l00266"></a>00266         }
<a name="l00267"></a>00267         SetWindowText(<a class="code" href="class_game_code_app.html#a4">GetHwnd</a>(), <a class="code" href="class_game_code_app.html#a1">VGetGameTitle</a>());
<a name="l00268"></a>00268 
<a name="l00269"></a>00269         <span class="comment">// initialize user settable game options - including finding the profiles directory</span>
<a name="l00270"></a>00270         _tcscpy(<a class="code" href="class_game_code_app.html#o4">m_saveGameDirectory</a>, <a class="code" href="_initialization_8cpp.html#a4">GetSaveGameDirectory</a>(<a class="code" href="class_game_code_app.html#a4">GetHwnd</a>(), <a class="code" href="class_game_code_app.html#a2">VGetGameAppDirectory</a>()));
<a name="l00271"></a>00271 
<a name="l00272"></a>00272         <span class="comment">// You usually must have an HWND to initialize your game views...</span>
<a name="l00273"></a>00273         <a class="code" href="class_game_code_app.html#o1">m_pGame</a> = <a class="code" href="class_game_code_app.html#a19">VCreateGameAndView</a>();
<a name="l00274"></a>00274         <span class="keywordflow">if</span> (!<a class="code" href="class_game_code_app.html#o1">m_pGame</a>)
<a name="l00275"></a>00275                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00276"></a>00276 
<a name="l00277"></a>00277         <a class="code" href="_d_x_u_t_8cpp.html#a78">DXUTCreateDevice</a>( D3DADAPTER_DEFAULT, <span class="keyword">true</span>, <a class="code" href="_game_code_std_8h.html#a9">SCREEN_WIDTH</a>, <a class="code" href="_game_code_std_8h.html#a10">SCREEN_HEIGHT</a>, <a class="code" href="class_game_code_app.html#e4">IsDeviceAcceptable</a>, <a class="code" href="class_game_code_app.html#e5">ModifyDeviceSettings</a> );
<a name="l00278"></a>00278 
<a name="l00279"></a>00279         <span class="comment">// initialize the font system</span>
<a name="l00280"></a>00280         <a class="code" href="class_game_code_app.html#p9">m_pFontHandler</a> = <a class="code" href="_game_code_std_8h.html#a2">GCC_NEW</a> <a class="code" href="class_font_handler.html">FontHandler</a>();
<a name="l00281"></a>00281 
<a name="l00282"></a>00282         <a class="code" href="class_game_code_app.html#p2">m_bIsRunning</a> = <span class="keyword">true</span>;
<a name="l00283"></a>00283 
<a name="l00284"></a>00284         <span class="keywordflow">return</span> TRUE;
<a name="l00285"></a>00285 }
<a name="l00286"></a>00286 
<a name="l00287"></a>00287 
<a name="l00288"></a>00288 
<a name="l00289"></a><a class="code" href="class_game_code_app.html#a7">00289</a> <span class="keywordtype">void</span> <a class="code" href="class_game_code_app.html#a7">GameCodeApp::ParseCommandLine</a>(LPTSTR lpCmdLine)
<a name="l00290"></a>00290 {
<a name="l00291"></a>00291         TCHAR *playersCmd = _T(<span class="stringliteral">"-players"</span>);
<a name="l00292"></a>00292         TCHAR *gameHostCmd = _T(<span class="stringliteral">"-gamehost"</span>);
<a name="l00293"></a>00293         TCHAR *listenCmd = _T(<span class="stringliteral">"-listen"</span>);
<a name="l00294"></a>00294         TCHAR *numAICmd = _T(<span class="stringliteral">"-numai"</span>);
<a name="l00295"></a>00295         TCHAR *c;
<a name="l00296"></a>00296         TCHAR temp[_MAX_PATH];
<a name="l00297"></a>00297 
<a name="l00298"></a>00298         <span class="keywordflow">if</span> (c=_tcsstr(lpCmdLine, playersCmd))
<a name="l00299"></a>00299         {
<a name="l00300"></a>00300                 _tcscpy(temp, c);
<a name="l00301"></a>00301                 c = temp;
<a name="l00302"></a>00302                 c = _tcstok(temp, _T(<span class="stringliteral">" "</span>));             <span class="comment">// get -players command</span>
<a name="l00303"></a>00303                 c = _tcstok(NULL, _T(<span class="stringliteral">" "</span>));
<a name="l00304"></a>00304                 <span class="keywordtype">int</span> players = _tstoi(c);
<a name="l00305"></a>00305                 <span class="keywordflow">if</span> (players&gt;6 || players&lt;1)
<a name="l00306"></a>00306                 {
<a name="l00307"></a>00307                         assert(0 &amp;&amp; <span class="stringliteral">"Invalid number of players on the command line"</span>);
<a name="l00308"></a>00308                         players = 1;
<a name="l00309"></a>00309                 }
<a name="l00310"></a>00310 
<a name="l00311"></a>00311                 <a class="code" href="class_game_code_app.html#o2">m_pOptions</a>-&gt;<a class="code" href="struct_game_options.html#o10">m_expectedPlayers</a> = players;
<a name="l00312"></a>00312         }
<a name="l00313"></a>00313 
<a name="l00314"></a>00314         <span class="keywordflow">if</span> (c=_tcsstr(lpCmdLine, gameHostCmd))
<a name="l00315"></a>00315         {
<a name="l00316"></a>00316                 _tcscpy(temp, c);
<a name="l00317"></a>00317                 c = temp;
<a name="l00318"></a>00318                 c = _tcstok(temp, _T(<span class="stringliteral">" "</span>));             <span class="comment">// get -hostname command</span>
<a name="l00319"></a>00319                 c = _tcstok(NULL, _T(<span class="stringliteral">" "</span>));             <span class="comment">// get to hostname</span>
<a name="l00320"></a>00320                 <span class="keywordflow">if</span> (c)
<a name="l00321"></a>00321                 {
<a name="l00322"></a>00322                         CHAR gameHost[256];
<a name="l00323"></a>00323                         <a class="code" href="_string_8cpp.html#a5">GenericToAnsiCch</a>(gameHost, c, static_cast&lt;int&gt;(_tcslen(c)+1));
<a name="l00324"></a>00324                         <a class="code" href="class_game_code_app.html#o2">m_pOptions</a>-&gt;<a class="code" href="struct_game_options.html#o12">m_gameHost</a> = gameHost;
<a name="l00325"></a>00325                 }
<a name="l00326"></a>00326                 c = _tcstok(NULL, _T(<span class="stringliteral">" "</span>));             <span class="comment">// get to port number</span>
<a name="l00327"></a>00327                 <span class="keywordflow">if</span> (c)
<a name="l00328"></a>00328                 {
<a name="l00329"></a>00329                         <span class="keywordtype">int</span> listenPort = _tstoi(c);
<a name="l00330"></a>00330                         <span class="keywordflow">if</span> (listenPort&gt;0 &amp;&amp; listenPort&lt;65535)
<a name="l00331"></a>00331                         {
<a name="l00332"></a>00332                                 <span class="comment">// the game options already has the default port set...</span>
<a name="l00333"></a>00333                                 <a class="code" href="class_game_code_app.html#o2">m_pOptions</a>-&gt;<a class="code" href="struct_game_options.html#o11">m_listenPort</a> = listenPort;
<a name="l00334"></a>00334                         }
<a name="l00335"></a>00335                 }               
<a name="l00336"></a>00336                 assert(<a class="code" href="class_game_code_app.html#o2">m_pOptions</a>-&gt;<a class="code" href="struct_game_options.html#o11">m_listenPort</a>!=-1 &amp;&amp; _T(<span class="stringliteral">"Must set server port in command line"</span>));
<a name="l00337"></a>00337         }
<a name="l00338"></a>00338 
<a name="l00339"></a>00339         <span class="keywordflow">if</span> (c=_tcsstr(lpCmdLine, listenCmd))
<a name="l00340"></a>00340         {
<a name="l00341"></a>00341                 _tcscpy(temp, c);
<a name="l00342"></a>00342                 c = temp;
<a name="l00343"></a>00343                 c = _tcstok(temp, _T(<span class="stringliteral">" "</span>));             <span class="comment">// get -listed command</span>
<a name="l00344"></a>00344                 c = _tcstok(NULL, _T(<span class="stringliteral">" "</span>));             <span class="comment">// get to port number</span>
<a name="l00345"></a>00345                 <span class="keywordtype">int</span> listenPort = _tstoi(c);
<a name="l00346"></a>00346                 <span class="keywordflow">if</span> (listenPort&gt;0 &amp;&amp; listenPort&lt;65535)
<a name="l00347"></a>00347                 {
<a name="l00348"></a>00348                         <a class="code" href="class_game_code_app.html#o2">m_pOptions</a>-&gt;<a class="code" href="struct_game_options.html#o11">m_listenPort</a> = listenPort;
<a name="l00349"></a>00349                 }
<a name="l00350"></a>00350         }
<a name="l00351"></a>00351 
<a name="l00352"></a>00352         <span class="keywordflow">if</span> (c=_tcsstr(lpCmdLine, numAICmd))
<a name="l00353"></a>00353         {
<a name="l00354"></a>00354                 _tcscpy(temp, c);
<a name="l00355"></a>00355                 c = temp;
<a name="l00356"></a>00356                 c = _tcstok(temp, _T(<span class="stringliteral">" "</span>));             <span class="comment">// get -numai command</span>
<a name="l00357"></a>00357                 c = _tcstok(NULL, _T(<span class="stringliteral">" "</span>));             <span class="comment">// get to port number</span>
<a name="l00358"></a>00358                 <span class="keywordtype">int</span> numAIs = _tstoi(c);
<a name="l00359"></a>00359                 <span class="keywordflow">if</span> (numAIs&gt;=0 &amp;&amp; numAIs&lt;=8)
<a name="l00360"></a>00360                 {
<a name="l00361"></a>00361                         <a class="code" href="class_game_code_app.html#o2">m_pOptions</a>-&gt;<a class="code" href="struct_game_options.html#o13">m_numAIs</a> = numAIs;
<a name="l00362"></a>00362                 }
<a name="l00363"></a>00363         }
<a name="l00364"></a>00364 
<a name="l00365"></a>00365 }
<a name="l00366"></a>00366 
<a name="l00367"></a>00367 
<a name="l00368"></a>00368 <span class="comment">/***</span>
<a name="l00369"></a>00369 <span class="comment">//=========================================================</span>
<a name="l00370"></a>00370 <span class="comment">// GameCodeApp::ValidWindowedMode</span>
<a name="l00371"></a>00371 <span class="comment">//</span>
<a name="l00372"></a>00372 <span class="comment">// Game Code Complete reference - Chapter 11, page 37</span>
<a name="l00373"></a>00373 <span class="comment">//=========================================================</span>
<a name="l00374"></a>00374 <span class="comment"></span>
<a name="l00375"></a>00375 <span class="comment">bool GameCodeApp::ValidWindowedMode ( )</span>
<a name="l00376"></a>00376 <span class="comment">{</span>
<a name="l00377"></a>00377 <span class="comment">        // Grab the new windows dimensions and color depth</span>
<a name="l00378"></a>00378 <span class="comment">        ::SystemParametersInfo( SPI_GETWORKAREA, 0, &amp;m_rcDesktop, 0 );</span>
<a name="l00379"></a>00379 <span class="comment">        HDC d = ::GetDC(NULL);</span>
<a name="l00380"></a>00380 <span class="comment">        m_iColorDepth = GetDeviceCaps(d, BITSPIXEL);</span>
<a name="l00381"></a>00381 <span class="comment">        ::ReleaseDC(NULL, d);</span>
<a name="l00382"></a>00382 <span class="comment"></span>
<a name="l00383"></a>00383 <span class="comment">        if ( m_rcDesktop.Width() &lt;= m_iScreenWidth || </span>
<a name="l00384"></a>00384 <span class="comment">                 m_rcDesktop.Height() &lt;= m_iScreenHeight ||</span>
<a name="l00385"></a>00385 <span class="comment">                ( m_iColorDepth == 24  ) ||</span>
<a name="l00386"></a>00386 <span class="comment">                ( m_iColorDepth &lt; 16 ) )</span>
<a name="l00387"></a>00387 <span class="comment">        {</span>
<a name="l00388"></a>00388 <span class="comment">                return false;</span>
<a name="l00389"></a>00389 <span class="comment">        }</span>
<a name="l00390"></a>00390 <span class="comment">        else</span>
<a name="l00391"></a>00391 <span class="comment">        {</span>
<a name="l00392"></a>00392 <span class="comment">                return true;</span>
<a name="l00393"></a>00393 <span class="comment">        }</span>
<a name="l00394"></a>00394 <span class="comment">}</span>
<a name="l00395"></a>00395 <span class="comment">**********/</span>
<a name="l00396"></a>00396 
<a name="l00397"></a>00397 <span class="comment">//----------------------------------------------------------</span>
<a name="l00398"></a>00398 <span class="comment">// GetString</span>
<a name="l00399"></a>00399 <span class="comment">//</span>
<a name="l00400"></a>00400 <span class="comment">// Bonus code - not described in the book.</span>
<a name="l00401"></a>00401 <span class="comment">//</span>
<a name="l00402"></a>00402 <span class="comment">// creates a string from a string resource ID in the string table</span>
<a name="l00403"></a>00403 <span class="comment">// stored in a special DLL, LANG.DLL, so game text strings</span>
<a name="l00404"></a>00404 <span class="comment">// can be language independant</span>
<a name="l00405"></a>00405 <span class="comment">//</span>
<a name="l00406"></a><a class="code" href="class_game_code_app.html#a17">00406</a> std::wstring <a class="code" href="class_game_code_app.html#a17">GameCodeApp::GetString</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> nID)
<a name="l00407"></a>00407 {
<a name="l00408"></a>00408         std::wstring s = _T(<span class="stringliteral">""</span>);
<a name="l00409"></a>00409         <a class="code" href="_d_x_u_tgui_8cpp.html#a39">BOOL</a> idFound = <span class="keyword">false</span>;
<a name="l00410"></a>00410         <span class="keywordflow">if</span> (<a class="code" href="class_game_code_app.html#p8">m_LangDll</a>)
<a name="l00411"></a>00411         {
<a name="l00412"></a>00412                 TCHAR temp[2048];
<a name="l00413"></a>00413                 <span class="comment">// first search in the lang_dll resources, if one has been specified</span>
<a name="l00414"></a>00414                 idFound = ::LoadString(<a class="code" href="class_game_code_app.html#p8">m_LangDll</a>, nID, temp, 2048);
<a name="l00415"></a>00415                 <span class="keywordflow">if</span> (idFound)
<a name="l00416"></a>00416                 {
<a name="l00417"></a>00417                         s = temp;
<a name="l00418"></a>00418                 }
<a name="l00419"></a>00419         }
<a name="l00420"></a>00420 
<a name="l00421"></a>00421         assert(s.length() &amp;&amp; _T(<span class="stringliteral">"String not found!"</span>));
<a name="l00422"></a>00422         <span class="keywordflow">return</span> s;
<a name="l00423"></a>00423 }
<a name="l00424"></a>00424 
<a name="l00425"></a>00425 
<a name="l00426"></a>00426 <span class="comment">//----------------------------------------------------------</span>
<a name="l00427"></a>00427 <span class="comment">// Win32 Specific Message Handlers</span>
<a name="l00428"></a>00428 <span class="comment">//</span>
<a name="l00429"></a>00429 <span class="comment">// WndProc - the main message handler for the window class</span>
<a name="l00430"></a>00430 <span class="comment">//</span>
<a name="l00431"></a>00431 <span class="comment">// OnNcCreate - this is where you can set window data before it is created</span>
<a name="l00432"></a>00432 <span class="comment">// OnMove - called whenever the window moves; used to update members of g_App</span>
<a name="l00433"></a>00433 <span class="comment">// OnDeviceChange - called whenever you eject the CD-ROM.</span>
<a name="l00434"></a>00434 <span class="comment">// OnDisplayChange - called whenever the user changes the desktop settings</span>
<a name="l00435"></a>00435 <span class="comment">// OnPowerBroadcast - called whenever a power message forces a shutdown</span>
<a name="l00436"></a>00436 <span class="comment">// OnActivate - called whenever windows on the desktop change focus.</span>
<a name="l00437"></a>00437 <span class="comment">//</span>
<a name="l00438"></a>00438 <span class="comment">// Note: pUserContext added to comply with DirectX 9c - June 2005 Update</span>
<a name="l00439"></a>00439 <span class="comment">//</span>
<a name="l00440"></a><a class="code" href="class_game_code_app.html#e0">00440</a> LRESULT CALLBACK <a class="code" href="class_game_code_app.html#e0">GameCodeApp::MsgProc</a>( <a class="code" href="_d_x_u_tgui_8cpp.html#a53">HWND</a> hWnd, <a class="code" href="_d_x_u_tgui_8cpp.html#a45">UINT</a> uMsg, WPARAM wParam, LPARAM lParam, <span class="keywordtype">bool</span>* pbNoFurtherProcessing, <span class="keywordtype">void</span>* <a class="code" href="_d_x_u_tgui_8h.html#a14">pUserContext</a> )
<a name="l00441"></a>00441 {
<a name="l00442"></a>00442     <span class="comment">// Always allow dialog resource manager calls to handle global messages</span>
<a name="l00443"></a>00443     <span class="comment">// so GUI state is updated correctly</span>
<a name="l00444"></a>00444     *pbNoFurtherProcessing = g_pApp-&gt;<a class="code" href="class_game_code_app.html#o0">m_pDialogResourceManager</a>-&gt;<a class="code" href="class_c_d_x_u_t_dialog_resource_manager.html#a6">MsgProc</a>( hWnd, uMsg, wParam, lParam );
<a name="l00445"></a>00445     <span class="keywordflow">if</span>( *pbNoFurtherProcessing )
<a name="l00446"></a>00446         <span class="keywordflow">return</span> 0;
<a name="l00447"></a>00447 
<a name="l00448"></a>00448         LRESULT result = 0;
<a name="l00449"></a>00449 
<a name="l00450"></a>00450         <span class="keywordflow">switch</span> (uMsg) 
<a name="l00451"></a>00451         {
<a name="l00452"></a>00452                 <span class="comment">/**************</span>
<a name="l00453"></a>00453 <span class="comment">                case WM_NCCREATE:</span>
<a name="l00454"></a>00454 <span class="comment">                {</span>
<a name="l00455"></a>00455 <span class="comment">                        return g_pApp-&gt;OnNcCreate((LPCREATESTRUCT)lParam);</span>
<a name="l00456"></a>00456 <span class="comment">                }</span>
<a name="l00457"></a>00457 <span class="comment"></span>
<a name="l00458"></a>00458 <span class="comment">                case WM_PAINT:</span>
<a name="l00459"></a>00459 <span class="comment">                        hdc = BeginPaint(hWnd, &amp;ps);</span>
<a name="l00460"></a>00460 <span class="comment">                        EndPaint(hWnd, &amp;ps);</span>
<a name="l00461"></a>00461 <span class="comment">                        break;</span>
<a name="l00462"></a>00462 <span class="comment"></span>
<a name="l00463"></a>00463 <span class="comment">                case WM_DESTROY:</span>
<a name="l00464"></a>00464 <span class="comment">                        PostQuitMessage(0);</span>
<a name="l00465"></a>00465 <span class="comment">                        break;</span>
<a name="l00466"></a>00466 <span class="comment"></span>
<a name="l00467"></a>00467 <span class="comment">                case WM_ACTIVATE:</span>
<a name="l00468"></a>00468 <span class="comment">                //  Changes made post-press:</span>
<a name="l00469"></a>00469 <span class="comment">                //    This message is actually handled by the DirectX 9 Framework.</span>
<a name="l00470"></a>00470 <span class="comment">                //    You could still intercept it, and handle things like pausing </span>
<a name="l00471"></a>00471 <span class="comment">                //    your game audio - but you should make sure DirectX 9 gets it too, </span>
<a name="l00472"></a>00472 <span class="comment">                //    or wierd things will happen.</span>
<a name="l00473"></a>00473 <span class="comment">                        break;</span>
<a name="l00474"></a>00474 <span class="comment"></span>
<a name="l00475"></a>00475 <span class="comment">                case WM_MOVE:</span>
<a name="l00476"></a>00476 <span class="comment">                //  Changes made post-press:</span>
<a name="l00477"></a>00477 <span class="comment">                //    The WM_MOVE message as described in the book had a little more to do</span>
<a name="l00478"></a>00478 <span class="comment">                //    with a particular quirk of the sprite engine used in the first edition.</span>
<a name="l00479"></a>00479 <span class="comment">                //    You don't have to handle it if you don't want to.</span>
<a name="l00480"></a>00480 <span class="comment">                        break;</span>
<a name="l00481"></a>00481 <span class="comment"></span>
<a name="l00482"></a>00482 <span class="comment">                **************************/</span>
<a name="l00483"></a>00483 
<a name="l00484"></a>00484                 <span class="keywordflow">case</span> WM_DEVICECHANGE:
<a name="l00485"></a>00485                 {
<a name="l00486"></a>00486                         <span class="keywordtype">int</span> event = (<a class="code" href="_d_x_u_tgui_8cpp.html#a37">int</a>)wParam;
<a name="l00487"></a>00487                         result = g_pApp-&gt;<a class="code" href="class_game_code_app.html#a10">OnDeviceChange</a>(event);
<a name="l00488"></a>00488                         <span class="keywordflow">break</span>;
<a name="l00489"></a>00489                 }
<a name="l00490"></a>00490 
<a name="l00491"></a>00491                 <span class="keywordflow">case</span> WM_POWERBROADCAST:
<a name="l00492"></a>00492                 {
<a name="l00493"></a>00493                         <span class="keywordtype">int</span> event = (<a class="code" href="_d_x_u_tgui_8cpp.html#a37">int</a>)wParam;
<a name="l00494"></a>00494                         result = g_pApp-&gt;<a class="code" href="class_game_code_app.html#a12">OnPowerBroadcast</a>(event);
<a name="l00495"></a>00495                         <span class="keywordflow">break</span>;
<a name="l00496"></a>00496                 }
<a name="l00497"></a>00497 
<a name="l00498"></a>00498                 <span class="keywordflow">case</span> WM_DISPLAYCHANGE:
<a name="l00499"></a>00499                 {
<a name="l00500"></a>00500                         <span class="keywordtype">int</span> colorDepth = (<a class="code" href="_d_x_u_tgui_8cpp.html#a37">int</a>)wParam;
<a name="l00501"></a>00501                         <span class="keywordtype">int</span> width = (<a class="code" href="_d_x_u_tgui_8cpp.html#a37">int</a>)(short) LOWORD(lParam);
<a name="l00502"></a>00502                         <span class="keywordtype">int</span> height = (<a class="code" href="_d_x_u_tgui_8cpp.html#a37">int</a>)(short) HIWORD(lParam);
<a name="l00503"></a>00503 
<a name="l00504"></a>00504                         result = g_pApp-&gt;<a class="code" href="class_game_code_app.html#a11">OnDisplayChange</a>(colorDepth, width, height);
<a name="l00505"></a>00505                         <span class="keywordflow">break</span>;
<a name="l00506"></a>00506                 }
<a name="l00507"></a>00507 
<a name="l00508"></a>00508                 <span class="keywordflow">case</span> WM_SYSCOMMAND: 
<a name="l00509"></a>00509                 {
<a name="l00510"></a>00510                         result = g_pApp-&gt;<a class="code" href="class_game_code_app.html#a13">OnSysCommand</a>(wParam, lParam);
<a name="l00511"></a>00511                         <span class="keywordflow">if</span> (result)
<a name="l00512"></a>00512                         {
<a name="l00513"></a>00513                                 *pbNoFurtherProcessing = <span class="keyword">true</span>;
<a name="l00514"></a>00514                         }
<a name="l00515"></a>00515                         <span class="keywordflow">break</span>;
<a name="l00516"></a>00516                 }
<a name="l00517"></a>00517 
<a name="l00518"></a>00518                 <span class="keywordflow">case</span> WM_SYSKEYDOWN:
<a name="l00519"></a>00519                 {
<a name="l00520"></a>00520                         <span class="keywordflow">if</span> (wParam == VK_RETURN)
<a name="l00521"></a>00521                         {
<a name="l00522"></a>00522                                 *pbNoFurtherProcessing = <span class="keyword">true</span>;
<a name="l00523"></a>00523                                 <span class="keywordflow">return</span> g_pApp-&gt;<a class="code" href="class_game_code_app.html#a15">OnAltEnter</a>();
<a name="l00524"></a>00524                         }
<a name="l00525"></a>00525                         <span class="keywordflow">return</span> DefWindowProc(hWnd, uMsg, wParam, lParam);
<a name="l00526"></a>00526                 }
<a name="l00527"></a>00527 
<a name="l00528"></a>00528 
<a name="l00529"></a>00529                 <span class="keywordflow">case</span> WM_CLOSE:
<a name="l00530"></a>00530                 {
<a name="l00531"></a>00531                         result = g_pApp-&gt;<a class="code" href="class_game_code_app.html#a14">OnClose</a>();
<a name="l00532"></a>00532                         <span class="keywordflow">break</span>;
<a name="l00533"></a>00533                 }
<a name="l00534"></a>00534 
<a name="l00535"></a>00535         <span class="keywordflow">case</span> WM_KEYDOWN:
<a name="l00536"></a>00536         <span class="keywordflow">case</span> WM_KEYUP:
<a name="l00537"></a>00537                 <span class="keywordflow">case</span> WM_MOUSEMOVE:
<a name="l00538"></a>00538                 <span class="keywordflow">case</span> WM_LBUTTONDOWN:
<a name="l00539"></a>00539                 <span class="keywordflow">case</span> WM_LBUTTONUP:
<a name="l00540"></a>00540                 <span class="keywordflow">case</span> WM_RBUTTONDOWN:
<a name="l00541"></a>00541                 <span class="keywordflow">case</span> WM_RBUTTONUP:
<a name="l00542"></a>00542                 {
<a name="l00543"></a>00543                         <span class="comment">//</span>
<a name="l00544"></a>00544                         <span class="comment">// See Chapter 9, page 265 for more explanation of this code.</span>
<a name="l00545"></a>00545                         <span class="comment">//</span>
<a name="l00546"></a>00546                         <span class="keywordflow">if</span> (g_pApp-&gt;<a class="code" href="class_game_code_app.html#o1">m_pGame</a>)
<a name="l00547"></a>00547                         {
<a name="l00548"></a>00548                                 <a class="code" href="class_base_game.html">BaseGame</a> *pGame = g_pApp-&gt;<a class="code" href="class_game_code_app.html#o1">m_pGame</a>;
<a name="l00549"></a>00549                                 <span class="comment">// Note the reverse order! User input is grabbed first from the view that is on top, </span>
<a name="l00550"></a>00550                                 <span class="comment">// which is the last one in the list.</span>
<a name="l00551"></a>00551                                 <a class="code" href="struct_app_msg.html">AppMsg</a> msg;
<a name="l00552"></a>00552                                 msg.<a class="code" href="struct_app_msg.html#o0">m_hWnd</a> = hWnd;
<a name="l00553"></a>00553                                 msg.<a class="code" href="struct_app_msg.html#o1">m_uMsg</a> = uMsg;
<a name="l00554"></a>00554                                 msg.<a class="code" href="struct_app_msg.html#o2">m_wParam</a> = wParam;
<a name="l00555"></a>00555                                 msg.<a class="code" href="struct_app_msg.html#o3">m_lParam</a> = lParam;
<a name="l00556"></a>00556                                 <span class="keywordflow">for</span>(GameViewList::reverse_iterator i=pGame-&gt;<a class="code" href="class_base_game.html#p6">m_gameViews</a>.rbegin(); i!=pGame-&gt;<a class="code" href="class_base_game.html#p6">m_gameViews</a>.rend(); ++i)
<a name="l00557"></a>00557                                 {
<a name="l00558"></a>00558                                         <span class="keywordflow">if</span> ( (*i)-&gt;VOnMsgProc( msg ) )
<a name="l00559"></a>00559                                         {
<a name="l00560"></a>00560                                                 result = <span class="keyword">true</span>;
<a name="l00561"></a>00561                                                 <span class="keywordflow">break</span>;                          <span class="comment">// WARNING! This breaks out of the for loop.</span>
<a name="l00562"></a>00562                                         }
<a name="l00563"></a>00563                                 }
<a name="l00564"></a>00564                         }
<a name="l00565"></a>00565                         <span class="keywordflow">break</span>;
<a name="l00566"></a>00566                 }
<a name="l00567"></a>00567 
<a name="l00568"></a>00568                 <span class="comment">/**********************</span>
<a name="l00569"></a>00569 <span class="comment">                WARNING!!!!! You MIGHT think you need this, but if you use the DirectX</span>
<a name="l00570"></a>00570 <span class="comment">                Framework the DefWindowProc is called for you....</span>
<a name="l00571"></a>00571 <span class="comment"></span>
<a name="l00572"></a>00572 <span class="comment">                default:</span>
<a name="l00573"></a>00573 <span class="comment">                        return DefWindowProc(hWnd, message, wParam, lParam);</span>
<a name="l00574"></a>00574 <span class="comment"></span>
<a name="l00575"></a>00575 <span class="comment">                ***********************/</span>
<a name="l00576"></a>00576         }
<a name="l00577"></a>00577 
<a name="l00578"></a>00578         <span class="keywordflow">return</span> result;
<a name="l00579"></a>00579 }
<a name="l00580"></a>00580 
<a name="l00581"></a>00581 
<a name="l00582"></a>00582 <span class="comment">//=========================================================</span>
<a name="l00583"></a>00583 <span class="comment">// GameCodeApp::OnNcCreate</span>
<a name="l00584"></a>00584 <span class="comment">//</span>
<a name="l00585"></a>00585 <span class="comment">// Handles the WM_NCCREATE message</span>
<a name="l00586"></a>00586 <span class="comment">//</span>
<a name="l00587"></a>00587 <span class="comment">// Not described in the book</span>
<a name="l00588"></a>00588 <span class="comment">// It sets a few members of the CREATESTRUCT, so the </span>
<a name="l00589"></a>00589 <span class="comment">// window looks like we want it to look.</span>
<a name="l00590"></a>00590 <span class="comment">//=========================================================</span>
<a name="l00591"></a>00591 
<a name="l00592"></a><a class="code" href="class_game_code_app.html#a16">00592</a> LRESULT <a class="code" href="class_game_code_app.html#a16">GameCodeApp::OnNcCreate</a>(LPCREATESTRUCT cs)
<a name="l00593"></a>00593 {
<a name="l00594"></a>00594         <span class="comment">// TODO: If you want to override something in the CREATESTRUCT, do it here!</span>
<a name="l00595"></a>00595         <span class="comment">// You'll usually do something like change window borders, etc.</span>
<a name="l00596"></a>00596         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00597"></a>00597 }
<a name="l00598"></a>00598 
<a name="l00599"></a>00599 
<a name="l00600"></a>00600 <span class="comment">//=========================================================</span>
<a name="l00601"></a>00601 <span class="comment">// GameCodeApp::OnDeviceChange - Chapter 17, page 654</span>
<a name="l00602"></a>00602 <span class="comment">//</span>
<a name="l00603"></a>00603 <span class="comment">// Handles the WM_DEVICECHANGE message</span>
<a name="l00604"></a>00604 <span class="comment">//=========================================================</span>
<a name="l00605"></a>00605 
<a name="l00606"></a><a class="code" href="class_game_code_app.html#a10">00606</a> LRESULT <a class="code" href="class_game_code_app.html#a10">GameCodeApp::OnDeviceChange</a>(<span class="keywordtype">int</span> eventType)
<a name="l00607"></a>00607 {                       
<a name="l00608"></a>00608         <span class="keywordflow">if</span> ( <a class="code" href="class_game_code_app.html#a21">IsMinimumInstall</a>() )               <span class="comment">// reads game data to find out</span>
<a name="l00609"></a>00609         {
<a name="l00610"></a>00610                 <span class="keywordflow">if</span> ( (<a class="code" href="_d_x_u_tgui_8cpp.html#a45">UINT</a>) eventType == DBT_DEVICEREMOVECOMPLETE )
<a name="l00611"></a>00611                 {
<a name="l00612"></a>00612                         TCHAR *searchFile = <a class="code" href="class_game_code_app.html#a22">CDCheckFile</a>();              
<a name="l00613"></a>00613                         <span class="keywordflow">while</span> (!<a class="code" href="class_game_code_app.html#a23">FileExists</a>(searchFile))
<a name="l00614"></a>00614                         {
<a name="l00615"></a>00615                                 <span class="keywordflow">if</span> (<a class="code" href="class_game_code_app.html#e1">GameCodeApp::Ask</a>(<a class="code" href="_game_code_8h.html#a16a9">QUESTION_WHERES_THE_CD</a>)==IDCANCEL)
<a name="l00616"></a>00616                                 {
<a name="l00617"></a>00617                                         <a class="code" href="class_game_code_app.html#a24">AbortGame</a>();
<a name="l00618"></a>00618                                 }
<a name="l00619"></a>00619                         }
<a name="l00620"></a>00620                         <span class="keywordflow">return</span> BROADCAST_QUERY_DENY;    <span class="comment">// denied!</span>
<a name="l00621"></a>00621                 }
<a name="l00622"></a>00622         }
<a name="l00623"></a>00623         
<a name="l00624"></a>00624         <span class="keywordflow">return</span> TRUE;
<a name="l00625"></a>00625 }
<a name="l00626"></a>00626 
<a name="l00627"></a>00627 
<a name="l00628"></a>00628 <span class="comment">//=========================================================</span>
<a name="l00629"></a>00629 <span class="comment">// GameCodeApp::OnDisplayChange - Chapter 17, page 656</span>
<a name="l00630"></a>00630 <span class="comment">//</span>
<a name="l00631"></a>00631 <span class="comment">// Handles the WM_DISPLAYCHANGE message</span>
<a name="l00632"></a>00632 <span class="comment">//</span>
<a name="l00633"></a>00633 <span class="comment">//=========================================================</span>
<a name="l00634"></a>00634 
<a name="l00635"></a><a class="code" href="class_game_code_app.html#a11">00635</a> LRESULT <a class="code" href="class_game_code_app.html#a11">GameCodeApp::OnDisplayChange</a>(<span class="keywordtype">int</span> colorDepth, <span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height)
<a name="l00636"></a>00636 {
<a name="l00637"></a>00637         <a class="code" href="class_game_code_app.html#p6">m_rcDesktop</a>.left = 0;
<a name="l00638"></a>00638         <a class="code" href="class_game_code_app.html#p6">m_rcDesktop</a>.top = 0; 
<a name="l00639"></a>00639         <a class="code" href="class_game_code_app.html#p6">m_rcDesktop</a>.right = width;
<a name="l00640"></a>00640         <a class="code" href="class_game_code_app.html#p6">m_rcDesktop</a>.bottom = height;
<a name="l00641"></a>00641         <a class="code" href="class_game_code_app.html#p7">m_iColorDepth</a> = colorDepth;
<a name="l00642"></a>00642         <span class="keywordflow">return</span> 0;
<a name="l00643"></a>00643 }
<a name="l00644"></a>00644 
<a name="l00645"></a>00645 <span class="comment">//=========================================================</span>
<a name="l00646"></a>00646 <span class="comment">// GameCodeApp::OnPowerBroadcast - Chapter 17, page 656</span>
<a name="l00647"></a>00647 <span class="comment">//</span>
<a name="l00648"></a>00648 <span class="comment">// Handles the WM_POWERBROADCAST message</span>
<a name="l00649"></a>00649 <span class="comment">//</span>
<a name="l00650"></a>00650 <span class="comment">//=========================================================</span>
<a name="l00651"></a>00651 
<a name="l00652"></a><a class="code" href="class_game_code_app.html#a12">00652</a> LRESULT <a class="code" href="class_game_code_app.html#a12">GameCodeApp::OnPowerBroadcast</a>(<span class="keywordtype">int</span> event)
<a name="l00653"></a>00653 {
<a name="l00654"></a>00654         <span class="comment">// Don't allow the game to go into sleep mode</span>
<a name="l00655"></a>00655         <span class="keywordflow">if</span> ( event == <a class="code" href="_d_x_u_t_8cpp.html#a12">PBT_APMQUERYSUSPEND</a> )
<a name="l00656"></a>00656                 <span class="keywordflow">return</span> BROADCAST_QUERY_DENY;
<a name="l00657"></a>00657         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( event == PBT_APMBATTERYLOW )
<a name="l00658"></a>00658         {
<a name="l00659"></a>00659                 <a class="code" href="class_game_code_app.html#a24">AbortGame</a>();
<a name="l00660"></a>00660         }
<a name="l00661"></a>00661 
<a name="l00662"></a>00662         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00663"></a>00663 }
<a name="l00664"></a>00664 
<a name="l00665"></a>00665 <span class="comment">//=========================================================</span>
<a name="l00666"></a>00666 <span class="comment">// GameCodeApp::OnSysCommand - Chapter 17, page 653</span>
<a name="l00667"></a>00667 <span class="comment">//</span>
<a name="l00668"></a>00668 <span class="comment">// Handles the WM_SYSCOMMAND message</span>
<a name="l00669"></a>00669 <span class="comment">//</span>
<a name="l00670"></a>00670 <span class="comment">//=========================================================</span>
<a name="l00671"></a>00671 
<a name="l00672"></a><a class="code" href="class_game_code_app.html#a13">00672</a> LRESULT <a class="code" href="class_game_code_app.html#a13">GameCodeApp::OnSysCommand</a>(WPARAM wParam, LPARAM lParam)
<a name="l00673"></a>00673 {
<a name="l00674"></a>00674         <span class="keywordflow">switch</span> (wParam)
<a name="l00675"></a>00675         {
<a name="l00676"></a>00676                 <span class="keywordflow">case</span> SC_MAXIMIZE :
<a name="l00677"></a>00677                 {
<a name="l00678"></a>00678                         <span class="comment">// If windowed and ready...</span>
<a name="l00679"></a>00679                         <span class="keywordflow">if</span> ( <a class="code" href="class_game_code_app.html#p1">m_bWindowedMode</a> &amp;&amp; <a class="code" href="class_game_code_app.html#a26">IsRunning</a>() )
<a name="l00680"></a>00680                         {
<a name="l00681"></a>00681                                 <span class="comment">// Make maximize into FULLSCREEN toggle</span>
<a name="l00682"></a>00682                                 <a class="code" href="class_game_code_app.html#a15">OnAltEnter</a>();
<a name="l00683"></a>00683                         }
<a name="l00684"></a>00684                 }
<a name="l00685"></a>00685                 <span class="keywordflow">return</span> 0;
<a name="l00686"></a>00686 
<a name="l00687"></a>00687                 <span class="keywordflow">case</span> SC_CLOSE :
<a name="l00688"></a>00688                 {
<a name="l00689"></a>00689                         <span class="comment">// The quit dialog confirmation would appear once for</span>
<a name="l00690"></a>00690                         <span class="comment">// every SC_CLOSE we get - which happens multiple times</span>
<a name="l00691"></a>00691                         <span class="comment">// if modal dialogs are up.  This now uses the QUIT_NO_PROMPT</span>
<a name="l00692"></a>00692                         <span class="comment">// flag to only prompt when receiving a SC_CLOSE that isn't</span>
<a name="l00693"></a>00693                         <span class="comment">// generated by us (identified by QUIT_NO_PROMPT).</span>
<a name="l00694"></a>00694                         
<a name="l00695"></a>00695                         <span class="comment">// If closing, prompt to close if this isn't a forced quit</span>
<a name="l00696"></a>00696                         <span class="keywordflow">if</span> ( lParam != <a class="code" href="_game_code_8h.html#a0">QUIT_NO_PROMPT</a> )
<a name="l00697"></a>00697                         {
<a name="l00698"></a>00698                                 <span class="comment">// ET - 05/21/01 - Bug #1916 - Begin</span>
<a name="l00699"></a>00699                                 <span class="comment">// We were receiving multiple close dialogs</span>
<a name="l00700"></a>00700                                 <span class="comment">// when closing again ALT-F4 while the close</span>
<a name="l00701"></a>00701                                 <span class="comment">// confirmation dialog was up.</span>
<a name="l00702"></a>00702                                 <span class="comment">// Eat if already servicing a close</span>
<a name="l00703"></a>00703                                 <span class="keywordflow">if</span> ( <a class="code" href="class_game_code_app.html#p3">m_bQuitRequested</a> )
<a name="l00704"></a>00704                                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00705"></a>00705 
<a name="l00706"></a>00706                                 <span class="comment">// Wait for the application to be restored</span>
<a name="l00707"></a>00707                                 <span class="comment">// before going any further with the new </span>
<a name="l00708"></a>00708                                 <span class="comment">// screen.  Flash until the person selects</span>
<a name="l00709"></a>00709                                 <span class="comment">// that they want to restore the game, then</span>
<a name="l00710"></a>00710                                 <span class="comment">// reinit the display if fullscreen.  </span>
<a name="l00711"></a>00711                                 <span class="comment">// The reinit is necessary otherwise the game</span>
<a name="l00712"></a>00712                                 <span class="comment">// will switch to windowed mode.</span>
<a name="l00713"></a>00713 
<a name="l00714"></a>00714                                 <span class="comment">// MLM TODO: Need a message eater, message saver</span>
<a name="l00715"></a>00715                                 <span class="comment">//if (postableMessageBacklog.valid())</span>
<a name="l00716"></a>00716                                 <span class="comment">//{</span>
<a name="l00717"></a>00717                                 <span class="comment">//      postableMessageBacklog-&gt;Add( PostableMessage(WM_SYSCOMMAND, wParam, MAKELPARAM(0, 0) ) );</span>
<a name="l00718"></a>00718                                 <span class="comment">//      return true;</span>
<a name="l00719"></a>00719                                 <span class="comment">//}</span>
<a name="l00720"></a>00720                 
<a name="l00721"></a>00721                                 <span class="comment">// Quit requested</span>
<a name="l00722"></a>00722                                 m_bQuitRequested = <span class="keyword">true</span>;
<a name="l00723"></a>00723                                 <span class="comment">// Prompt</span>
<a name="l00724"></a>00724                                 <span class="keywordflow">if</span> ( <a class="code" href="class_game_code_app.html#e1">GameCodeApp::Ask</a>(<a class="code" href="_game_code_8h.html#a16a10">QUESTION_QUIT_GAME</a>) == IDNO )
<a name="l00725"></a>00725                                 {
<a name="l00726"></a>00726                                         <span class="comment">// Bail - quit aborted</span>
<a name="l00727"></a>00727                                         
<a name="l00728"></a>00728                                         <span class="comment">// Reset quit requested flag</span>
<a name="l00729"></a>00729                                         m_bQuitRequested = <span class="keyword">false</span>;
<a name="l00730"></a>00730                                         
<a name="l00731"></a>00731                                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00732"></a>00732                                 }
<a name="l00733"></a>00733                         }
<a name="l00734"></a>00734         
<a name="l00735"></a>00735                         <a class="code" href="class_game_code_app.html#p4">m_bQuitting</a> = <span class="keyword">true</span>;
<a name="l00736"></a>00736 
<a name="l00737"></a>00737                         <span class="comment">// Is there a game modal dialog up?</span>
<a name="l00738"></a>00738                         <span class="keywordflow">if</span> ( <a class="code" href="class_game_code_app.html#a8">HasModalDialog</a>() )
<a name="l00739"></a>00739                         {
<a name="l00740"></a>00740                                 <span class="comment">// Close the modal</span>
<a name="l00741"></a>00741                                 <span class="comment">// and keep posting close to the app</span>
<a name="l00742"></a>00742                                 <a class="code" href="class_game_code_app.html#a9">ForceModalExit</a>();
<a name="l00743"></a>00743 
<a name="l00744"></a>00744                                 <span class="comment">// Reissue the close to the app</span>
<a name="l00745"></a>00745                                 
<a name="l00746"></a>00746                                 <span class="comment">// Issue the new close after handling the current one,</span>
<a name="l00747"></a>00747                                 <span class="comment">// but send in QUIT_NO_PROMPT to differentiate it from a </span>
<a name="l00748"></a>00748                                 <span class="comment">// regular CLOSE issued by the system.</span>
<a name="l00749"></a>00749                                 PostMessage( <a class="code" href="class_game_code_app.html#a4">GetHwnd</a>(), WM_SYSCOMMAND, SC_CLOSE, <a class="code" href="_game_code_8h.html#a0">QUIT_NO_PROMPT</a> );
<a name="l00750"></a>00750 
<a name="l00751"></a>00751                                 <a class="code" href="class_game_code_app.html#p3">m_bQuitRequested</a> = <span class="keyword">false</span>;
<a name="l00752"></a>00752                                 
<a name="l00753"></a>00753                                 <span class="comment">// Eat the close</span>
<a name="l00754"></a>00754                                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00755"></a>00755                         }
<a name="l00756"></a>00756 
<a name="l00757"></a>00757                         <span class="comment">// Reset the quit after any other dialogs have popped up from this close</span>
<a name="l00758"></a>00758                         <a class="code" href="class_game_code_app.html#p3">m_bQuitRequested</a> = <span class="keyword">false</span>;
<a name="l00759"></a>00759                 }
<a name="l00760"></a>00760                 <span class="keywordflow">return</span> 0;
<a name="l00761"></a>00761 
<a name="l00762"></a>00762                 <span class="keywordflow">default</span>:
<a name="l00763"></a>00763                         <span class="comment">// return non-zero of we didn't process the SYSCOMMAND message</span>
<a name="l00764"></a>00764                         <span class="keywordflow">return</span> DefWindowProc(<a class="code" href="class_game_code_app.html#a4">GetHwnd</a>(), WM_SYSCOMMAND, wParam, lParam);
<a name="l00765"></a>00765         }
<a name="l00766"></a>00766 
<a name="l00767"></a>00767         <span class="keywordflow">return</span> 0;
<a name="l00768"></a>00768 }
<a name="l00769"></a>00769 
<a name="l00770"></a>00770 <span class="comment">//=========================================================</span>
<a name="l00771"></a>00771 <span class="comment">// GameCodeApp::OnClose - Chapter 5, page 154</span>
<a name="l00772"></a>00772 <span class="comment">//</span>
<a name="l00773"></a>00773 <span class="comment">// Handles the WM_CLOSE message</span>
<a name="l00774"></a>00774 <span class="comment">//</span>
<a name="l00775"></a>00775 <span class="comment">//=========================================================</span>
<a name="l00776"></a>00776 
<a name="l00777"></a><a class="code" href="class_game_code_app.html#a14">00777</a> LRESULT <a class="code" href="class_game_code_app.html#a14">GameCodeApp::OnClose</a>()
<a name="l00778"></a>00778 {
<a name="l00779"></a>00779         <span class="comment">// release all the game systems in reverse order from which they were created</span>
<a name="l00780"></a>00780 
<a name="l00781"></a>00781         <a class="code" href="dxstdafx_8h.html#a7">SAFE_DELETE</a>(<a class="code" href="class_game_code_app.html#o1">m_pGame</a>);
<a name="l00782"></a>00782 
<a name="l00783"></a>00783         <a class="code" href="dxstdafx_8h.html#a7">SAFE_DELETE</a>(<a class="code" href="class_game_code_app.html#p9">m_pFontHandler</a>);
<a name="l00784"></a>00784 
<a name="l00785"></a>00785         DestroyWindow(<a class="code" href="class_game_code_app.html#a4">GetHwnd</a>());
<a name="l00786"></a>00786 
<a name="l00787"></a>00787         <a class="code" href="dxstdafx_8h.html#a7">SAFE_DELETE</a>(<a class="code" href="class_game_code_app.html#o3">m_ResCache</a>);
<a name="l00788"></a>00788 
<a name="l00789"></a>00789         <a class="code" href="dxstdafx_8h.html#a7">SAFE_DELETE</a>(<a class="code" href="class_game_code_app.html#o6">m_pBaseSocketManager</a>);
<a name="l00790"></a>00790 
<a name="l00791"></a>00791         <a class="code" href="dxstdafx_8h.html#a7">SAFE_DELETE</a>(<a class="code" href="class_game_code_app.html#o5">m_pEventManager</a>);
<a name="l00792"></a>00792 
<a name="l00793"></a>00793         <a class="code" href="dxstdafx_8h.html#a7">SAFE_DELETE</a>(<a class="code" href="class_game_code_app.html#o2">m_pOptions</a>);
<a name="l00794"></a>00794         <span class="keywordflow">return</span> 0;
<a name="l00795"></a>00795 }
<a name="l00796"></a>00796 
<a name="l00797"></a>00797 
<a name="l00798"></a>00798 
<a name="l00799"></a>00799 <span class="comment">//=========================================================</span>
<a name="l00800"></a>00800 <span class="comment">// GameCodeApp::FlashWhileMinimized - Chapter 5, page 150</span>
<a name="l00801"></a>00801 <span class="comment">//</span>
<a name="l00802"></a>00802 <span class="comment">// Wait for the application to be restored</span>
<a name="l00803"></a>00803 <span class="comment">// before going any further with the new </span>
<a name="l00804"></a>00804 <span class="comment">// screen.  Flash until the person selects</span>
<a name="l00805"></a>00805 <span class="comment">// that they want to restore the game.</span>
<a name="l00806"></a>00806 <span class="comment">//</span>
<a name="l00807"></a>00807 <span class="comment">//=========================================================</span>
<a name="l00808"></a>00808 
<a name="l00809"></a><a class="code" href="class_game_code_app.html#b3">00809</a> <span class="keywordtype">void</span> <a class="code" href="class_game_code_app.html#b3">GameCodeApp::FlashWhileMinimized</a>()
<a name="l00810"></a>00810 {
<a name="l00811"></a>00811         <span class="comment">// Flash the application on the taskbar</span>
<a name="l00812"></a>00812         <span class="comment">// until it's restored.</span>
<a name="l00813"></a>00813         <span class="keywordflow">if</span> ( ! <a class="code" href="class_game_code_app.html#a4">GetHwnd</a>() )
<a name="l00814"></a>00814                 <span class="keywordflow">return</span>;
<a name="l00815"></a>00815         
<a name="l00816"></a>00816         <span class="comment">// Blink the application if we are minimized,</span>
<a name="l00817"></a>00817         <span class="comment">// waiting until we are no longer minimized</span>
<a name="l00818"></a>00818         <span class="keywordflow">if</span> (IsIconic(<a class="code" href="class_game_code_app.html#a4">GetHwnd</a>()) )
<a name="l00819"></a>00819         {
<a name="l00820"></a>00820                 <span class="comment">// Make sure the app is up when creating a new screen</span>
<a name="l00821"></a>00821                 <span class="comment">// this should be the case most of the time, but when</span>
<a name="l00822"></a>00822                 <span class="comment">// we close the app down, minimized, and a confirmation</span>
<a name="l00823"></a>00823                 <span class="comment">// dialog appears, we need to restore</span>
<a name="l00824"></a>00824                 <a class="code" href="_d_x_u_tgui_8cpp.html#a38">DWORD</a> now = timeGetTime();
<a name="l00825"></a>00825                 <a class="code" href="_d_x_u_tgui_8cpp.html#a38">DWORD</a> then = now;
<a name="l00826"></a>00826                 MSG msg;
<a name="l00827"></a>00827                 
<a name="l00828"></a>00828                 FlashWindow( <a class="code" href="class_game_code_app.html#a4">GetHwnd</a>(), <span class="keyword">true</span> );
<a name="l00829"></a>00829                 
<a name="l00830"></a>00830                 <span class="keywordflow">for</span> (;;)
<a name="l00831"></a>00831                 {
<a name="l00832"></a>00832                         <span class="keywordflow">if</span> ( PeekMessage( &amp;msg, NULL, 0, 0, PM_NOREMOVE ) )
<a name="l00833"></a>00833                         {
<a name="l00834"></a>00834                                 <span class="comment">// Bug with closing the game multiple times while minimized</span>
<a name="l00835"></a>00835                                 <span class="comment">// Uncomment this to fix the problem</span>
<a name="l00836"></a>00836                                 <span class="keywordflow">if</span> ( msg.message == WM_SYSCOMMAND &amp;&amp; msg.wParam == SC_CLOSE )
<a name="l00837"></a>00837                                 {
<a name="l00838"></a>00838                                         <span class="comment">// Swallow close messages (we are already minimized and closing)        </span>
<a name="l00839"></a>00839                                         GetMessage( &amp;msg, NULL, NULL, NULL );
<a name="l00840"></a>00840                                 }
<a name="l00841"></a>00841                                 <span class="keywordflow">else</span>
<a name="l00842"></a>00842                                 {
<a name="l00843"></a>00843                                         <span class="comment">// Default processing</span>
<a name="l00844"></a>00844                                         <span class="comment">// MFC used PumpMessage();</span>
<a name="l00845"></a>00845                                         <span class="keywordflow">if</span> (GetMessage(&amp;msg, NULL, NULL, NULL))
<a name="l00846"></a>00846                                         {
<a name="l00847"></a>00847                                                 TranslateMessage(&amp;msg);
<a name="l00848"></a>00848                                                 DispatchMessage(&amp;msg);
<a name="l00849"></a>00849                                         }
<a name="l00850"></a>00850                                 }
<a name="l00851"></a>00851                                 
<a name="l00852"></a>00852                                 <span class="comment">// Are we done?</span>
<a name="l00853"></a>00853                                 <span class="keywordflow">if</span> ( ! IsIconic(<a class="code" href="class_game_code_app.html#a4">GetHwnd</a>()) )
<a name="l00854"></a>00854                                 {
<a name="l00855"></a>00855                                         FlashWindow( <a class="code" href="class_game_code_app.html#a4">GetHwnd</a>(), <span class="keyword">false</span> );
<a name="l00856"></a>00856                                         <span class="keywordflow">break</span>;
<a name="l00857"></a>00857                                 }
<a name="l00858"></a>00858                         }
<a name="l00859"></a>00859                         <span class="keywordflow">else</span>
<a name="l00860"></a>00860                         {
<a name="l00861"></a>00861                                 now = timeGetTime();
<a name="l00862"></a>00862                                 <span class="comment">// Changed to inline trinary use instead of abs() to circumvent 'ambiguous call to overloaded</span>
<a name="l00863"></a>00863                                 <span class="comment">// function abs()' error in VS.NET 2k3 -taj</span>
<a name="l00864"></a>00864                                 <span class="comment">//if ( abs( now - then ) &gt; 1000 )</span>
<a name="l00865"></a>00865                                 <a class="code" href="_d_x_u_tgui_8cpp.html#a38">DWORD</a> timeSpan = now &gt; then ? (now - then) : (then - now);
<a name="l00866"></a>00866                                 <span class="keywordflow">if</span> ( timeSpan &gt; 1000 )
<a name="l00867"></a>00867                                 {
<a name="l00868"></a>00868                                         then = now;
<a name="l00869"></a>00869                                         FlashWindow( <a class="code" href="class_game_code_app.html#a4">GetHwnd</a>(), <span class="keyword">true</span> );
<a name="l00870"></a>00870                                 }
<a name="l00871"></a>00871                         }
<a name="l00872"></a>00872                 }
<a name="l00873"></a>00873         }
<a name="l00874"></a>00874 }
<a name="l00875"></a>00875 
<a name="l00876"></a>00876 
<a name="l00877"></a><a class="code" href="class_game_code_app.html#e1">00877</a> <span class="keywordtype">int</span> <a class="code" href="class_game_code_app.html#e1">GameCodeApp::Ask</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> question)
<a name="l00878"></a>00878 {
<a name="l00879"></a>00879         std::wstring msg;
<a name="l00880"></a>00880         std::wstring title;
<a name="l00881"></a>00881         <span class="keywordtype">int</span> buttonFlags;
<a name="l00882"></a>00882         <span class="keywordtype">int</span> defaultAnswer = IDOK;
<a name="l00883"></a>00883 
<a name="l00884"></a>00884         <span class="keywordflow">switch</span>(question)
<a name="l00885"></a>00885         {
<a name="l00886"></a>00886                 <span class="keywordflow">case</span> <a class="code" href="_game_code_8h.html#a16a9">QUESTION_WHERES_THE_CD</a>:
<a name="l00887"></a>00887                 {
<a name="l00888"></a>00888                         msg = g_pApp-&gt;<a class="code" href="class_game_code_app.html#a17">GetString</a>(<a class="code" href="_strings_8h.html#a1">IDS_QUESTION_WHERES_THE_CD</a>);
<a name="l00889"></a>00889                         title = g_pApp-&gt;<a class="code" href="class_game_code_app.html#a17">GetString</a>(<a class="code" href="_strings_8h.html#a2">IDS_ALERT</a>);
<a name="l00890"></a>00890                         buttonFlags = MB_RETRYCANCEL|MB_ICONEXCLAMATION;
<a name="l00891"></a>00891                         defaultAnswer = IDCANCEL;
<a name="l00892"></a>00892                         <span class="keywordflow">break</span>;
<a name="l00893"></a>00893                 }
<a name="l00894"></a>00894                 <span class="keywordflow">case</span> <a class="code" href="_game_code_8h.html#a16a10">QUESTION_QUIT_GAME</a>:
<a name="l00895"></a>00895                 {
<a name="l00896"></a>00896                         msg = g_pApp-&gt;<a class="code" href="class_game_code_app.html#a17">GetString</a>(<a class="code" href="_strings_8h.html#a4">IDS_QUESTION_QUIT_GAME</a>);
<a name="l00897"></a>00897                         title = g_pApp-&gt;<a class="code" href="class_game_code_app.html#a17">GetString</a>(<a class="code" href="_strings_8h.html#a3">IDS_QUESTION</a>);
<a name="l00898"></a>00898                         buttonFlags = MB_YESNO|MB_ICONQUESTION;
<a name="l00899"></a>00899                         defaultAnswer = IDNO;
<a name="l00900"></a>00900                         <span class="keywordflow">break</span>;
<a name="l00901"></a>00901                 }
<a name="l00902"></a>00902                 <span class="keywordflow">default</span>:
<a name="l00903"></a>00903                         assert(0 &amp;&amp; _T(<span class="stringliteral">"Undefined question in Game::Ask"</span>));
<a name="l00904"></a>00904                         <span class="keywordflow">return</span> IDCANCEL;
<a name="l00905"></a>00905         }
<a name="l00906"></a>00906 
<a name="l00907"></a>00907         <span class="keywordflow">if</span> (g_pApp &amp;&amp; g_pApp-&gt;<a class="code" href="class_game_code_app.html#a26">IsRunning</a>())
<a name="l00908"></a>00908         {
<a name="l00909"></a>00909                 ShowCursor(<span class="keyword">true</span>);
<a name="l00910"></a>00910                 shared_ptr&lt;CMessageBox&gt; pMessageBox(<span class="keyword">new</span> <a class="code" href="class_c_message_box.html">CMessageBox</a>(msg, title, buttonFlags));
<a name="l00911"></a>00911                 <span class="keywordtype">int</span> result = g_pApp-&gt;<a class="code" href="class_game_code_app.html#b0">Modal</a>(pMessageBox, defaultAnswer);
<a name="l00912"></a>00912                 ShowCursor(<span class="keyword">false</span>);
<a name="l00913"></a>00913                 <span class="keywordflow">return</span> result;
<a name="l00914"></a>00914         }
<a name="l00915"></a>00915 
<a name="l00916"></a>00916         <span class="keywordflow">return</span> MessageBox(g_pApp ? g_pApp-&gt;<a class="code" href="class_game_code_app.html#a4">GetHwnd</a>() : NULL, msg.c_str(), title.c_str(), buttonFlags);
<a name="l00917"></a>00917 }
<a name="l00918"></a>00918 
<a name="l00919"></a>00919 
<a name="l00920"></a>00920 <span class="comment">//=========================================================</span>
<a name="l00921"></a>00921 <span class="comment">// GameCodeApp::OnAltEnter</span>
<a name="l00922"></a>00922 <span class="comment">//</span>
<a name="l00923"></a>00923 <span class="comment">// Called when the player hits Alt-Enter to flip the </span>
<a name="l00924"></a>00924 <span class="comment">// display mode.</span>
<a name="l00925"></a>00925 <span class="comment">//</span>
<a name="l00926"></a>00926 <span class="comment">// Not discussed in the book.</span>
<a name="l00927"></a>00927 <span class="comment">//=========================================================</span>
<a name="l00928"></a>00928 
<a name="l00929"></a><a class="code" href="class_game_code_app.html#a15">00929</a> LRESULT <a class="code" href="class_game_code_app.html#a15">GameCodeApp::OnAltEnter</a>()
<a name="l00930"></a>00930 {
<a name="l00931"></a>00931         <a class="code" href="_d_x_u_t_8cpp.html#a81">DXUTToggleFullScreen</a>();
<a name="l00932"></a>00932         <span class="keywordflow">return</span> 0;
<a name="l00933"></a>00933 }
<a name="l00934"></a>00934 
<a name="l00935"></a>00935 
<a name="l00936"></a>00936 <span class="comment">//</span>
<a name="l00937"></a>00937 <span class="comment">// class GameCodeApp::Modal - Chapter 9, page 272</span>
<a name="l00938"></a>00938 <span class="comment">//</span>
<a name="l00939"></a><a class="code" href="class_game_code_app.html#b0">00939</a> <span class="keywordtype">int</span> <a class="code" href="class_game_code_app.html#b0">GameCodeApp::Modal</a>(shared_ptr&lt;IScreenElement&gt; pModalScreen, <span class="keywordtype">int</span> defaultAnswer)
<a name="l00940"></a>00940 {
<a name="l00941"></a>00941         <span class="comment">// If we're going to display a dialog box, we need a human view </span>
<a name="l00942"></a>00942         <span class="comment">// to interact with.</span>
<a name="l00943"></a>00943         <a class="code" href="class_human_view.html">HumanView</a> *pView;
<a name="l00944"></a>00944         <span class="keywordflow">for</span>(GameViewList::iterator i=<a class="code" href="class_game_code_app.html#o1">m_pGame</a>-&gt;<a class="code" href="class_base_game.html#p6">m_gameViews</a>.begin(); i!=<a class="code" href="class_game_code_app.html#o1">m_pGame</a>-&gt;<a class="code" href="class_base_game.html#p6">m_gameViews</a>.end(); ++i)
<a name="l00945"></a>00945         {
<a name="l00946"></a>00946                 <span class="keywordflow">if</span> ((*i)-&gt;VGetType()==<a class="code" href="interfaces_8h.html#a14a4">GameView_Human</a>)
<a name="l00947"></a>00947                 {
<a name="l00948"></a>00948                         shared_ptr&lt;IGameView&gt; pIGameView(*i);
<a name="l00949"></a>00949                         pView = static_cast&lt;HumanView *&gt;(&amp;*pIGameView);
<a name="l00950"></a>00950                 }
<a name="l00951"></a>00951         }
<a name="l00952"></a>00952 
<a name="l00953"></a>00953         <span class="keywordflow">if</span> (!pView)
<a name="l00954"></a>00954         {
<a name="l00955"></a>00955                 <span class="comment">// Whoops! There's no human view attached.</span>
<a name="l00956"></a>00956                 <span class="keywordflow">return</span> defaultAnswer;
<a name="l00957"></a>00957         }
<a name="l00958"></a>00958 
<a name="l00959"></a>00959         <span class="keywordflow">if</span> (<a class="code" href="class_game_code_app.html#p10">m_HasModalDialog</a> &amp; 0x10000000)
<a name="l00960"></a>00960         {
<a name="l00961"></a>00961                 assert(0 &amp;&amp; <span class="stringliteral">"Too Many nested dialogs!"</span>);
<a name="l00962"></a>00962                 <span class="keywordflow">return</span> defaultAnswer;
<a name="l00963"></a>00963         }
<a name="l00964"></a>00964         
<a name="l00965"></a>00965         assert(<a class="code" href="class_game_code_app.html#a4">GetHwnd</a>() != NULL &amp;&amp; _T(<span class="stringliteral">"Main Window is NULL!"</span>));
<a name="l00966"></a>00966         <span class="keywordflow">if</span> ( ( <a class="code" href="class_game_code_app.html#a4">GetHwnd</a>() != NULL ) &amp;&amp; IsIconic(<a class="code" href="class_game_code_app.html#a4">GetHwnd</a>()) )
<a name="l00967"></a>00967         {
<a name="l00968"></a>00968                 <a class="code" href="class_game_code_app.html#b3">FlashWhileMinimized</a>();
<a name="l00969"></a>00969         }
<a name="l00970"></a>00970 
<a name="l00971"></a>00971 
<a name="l00972"></a>00972         <a class="code" href="class_game_code_app.html#p10">m_HasModalDialog</a> &lt;&lt;= 1;
<a name="l00973"></a>00973         <a class="code" href="class_game_code_app.html#p10">m_HasModalDialog</a> |= 1;
<a name="l00974"></a>00974 
<a name="l00975"></a>00975         pView-&gt;<a class="code" href="class_human_view.html#a6">VPushElement</a>(pModalScreen);
<a name="l00976"></a>00976 
<a name="l00977"></a>00977         LPARAM lParam = 0;
<a name="l00978"></a>00978         <span class="keywordtype">int</span> result = <a class="code" href="class_game_code_app.html#b1">PumpUntilMessage</a>(<a class="code" href="_game_code_8h.html#a1">MSG_END_MODAL</a>, NULL, &amp;lParam);
<a name="l00979"></a>00979         
<a name="l00980"></a>00980         <span class="keywordflow">if</span> (lParam != 0)
<a name="l00981"></a>00981         {
<a name="l00982"></a>00982                 <span class="keywordflow">if</span> (lParam==<a class="code" href="_game_code_8h.html#a0">QUIT_NO_PROMPT</a>)
<a name="l00983"></a>00983                         result = defaultAnswer;
<a name="l00984"></a>00984                 <span class="keywordflow">else</span>    
<a name="l00985"></a>00985                         result = (<a class="code" href="_d_x_u_tgui_8cpp.html#a37">int</a>)lParam;
<a name="l00986"></a>00986         }
<a name="l00987"></a>00987 
<a name="l00988"></a>00988         pView-&gt;<a class="code" href="class_human_view.html#a7">VPopElement</a>();
<a name="l00989"></a>00989         <a class="code" href="class_game_code_app.html#p10">m_HasModalDialog</a> &gt;&gt;= 1;
<a name="l00990"></a>00990 
<a name="l00991"></a>00991         <span class="keywordflow">return</span> result;
<a name="l00992"></a>00992 }
<a name="l00993"></a>00993 
<a name="l00994"></a>00994 <span class="comment">//</span>
<a name="l00995"></a>00995 <span class="comment">// class GameCodeApp::PumpUntilMessage - Chapter 9, page 278-79</span>
<a name="l00996"></a>00996 <span class="comment">//</span>
<a name="l00997"></a><a class="code" href="class_game_code_app.html#b1">00997</a> <span class="keywordtype">int</span> <a class="code" href="class_game_code_app.html#b1">GameCodeApp::PumpUntilMessage</a> (<a class="code" href="_d_x_u_tgui_8cpp.html#a45">UINT</a> msgEnd, WPARAM* pWParam, LPARAM* pLParam)
<a name="l00998"></a>00998 {
<a name="l00999"></a>00999         <span class="keywordtype">int</span> currentTime = timeGetTime();
<a name="l01000"></a>01000         MSG msg;
<a name="l01001"></a>01001         <span class="keywordflow">for</span> ( ;; )
<a name="l01002"></a>01002         {
<a name="l01003"></a>01003                 <span class="keywordflow">if</span> ( PeekMessage( &amp;msg, NULL, 0, 0, PM_NOREMOVE ) )
<a name="l01004"></a>01004                 {
<a name="l01005"></a>01005                         <span class="keywordflow">if</span> (msg.message == WM_CLOSE)
<a name="l01006"></a>01006                         {
<a name="l01007"></a>01007                                 <a class="code" href="class_game_code_app.html#p4">m_bQuitting</a> = <span class="keyword">true</span>;
<a name="l01008"></a>01008                                 GetMessage(&amp; msg, NULL, 0, 0);
<a name="l01009"></a>01009                                 <span class="keywordflow">break</span>;
<a name="l01010"></a>01010                         }
<a name="l01011"></a>01011                         <span class="keywordflow">else</span>
<a name="l01012"></a>01012                         {
<a name="l01013"></a>01013                                 <span class="comment">// Default processing</span>
<a name="l01014"></a>01014                                 <span class="keywordflow">if</span> (GetMessage(&amp;msg, NULL, NULL, NULL))
<a name="l01015"></a>01015                                 {
<a name="l01016"></a>01016                                         TranslateMessage(&amp;msg);
<a name="l01017"></a>01017                                         DispatchMessage(&amp;msg);
<a name="l01018"></a>01018                                 }
<a name="l01019"></a>01019 
<a name="l01020"></a>01020                                 <span class="comment">// Are we done?</span>
<a name="l01021"></a>01021                                 <span class="keywordflow">if</span> ( msg.message == msgEnd)
<a name="l01022"></a>01022                                         <span class="keywordflow">break</span>;
<a name="l01023"></a>01023                         }
<a name="l01024"></a>01024                 }
<a name="l01025"></a>01025                 <span class="keywordflow">else</span>
<a name="l01026"></a>01026                 {
<a name="l01027"></a>01027                         <span class="comment">// Update the game views, but nothing else!</span>
<a name="l01028"></a>01028                         <span class="comment">// Remember this is a modal screen.</span>
<a name="l01029"></a>01029                         <span class="keywordflow">if</span> (<a class="code" href="class_game_code_app.html#o1">m_pGame</a>)
<a name="l01030"></a>01030                         {
<a name="l01031"></a>01031                                 <span class="keywordtype">int</span> timeNow = timeGetTime();
<a name="l01032"></a>01032                                 <span class="keywordtype">int</span> deltaMilliseconds = timeNow - currentTime;
<a name="l01033"></a>01033                                 <span class="keywordflow">for</span>(GameViewList::iterator i=<a class="code" href="class_game_code_app.html#o1">m_pGame</a>-&gt;<a class="code" href="class_base_game.html#p6">m_gameViews</a>.begin(); i!=<a class="code" href="class_game_code_app.html#o1">m_pGame</a>-&gt;<a class="code" href="class_base_game.html#p6">m_gameViews</a>.end(); ++i)
<a name="l01034"></a>01034                                 {
<a name="l01035"></a>01035                                         (*i)-&gt;VOnUpdate( deltaMilliseconds );
<a name="l01036"></a>01036                                 }
<a name="l01037"></a>01037                                 currentTime = timeNow;
<a name="l01038"></a>01038                                 <a class="code" href="_d_x_u_t_8cpp.html#a45">DXUTRender3DEnvironment</a>();
<a name="l01039"></a>01039                         }
<a name="l01040"></a>01040                 }
<a name="l01041"></a>01041         }
<a name="l01042"></a>01042         <span class="keywordflow">if</span> (pLParam)
<a name="l01043"></a>01043                 *pLParam = msg.lParam;
<a name="l01044"></a>01044         <span class="keywordflow">if</span> (pWParam)
<a name="l01045"></a>01045                 *pWParam = msg.wParam;
<a name="l01046"></a>01046 
<a name="l01047"></a>01047         <span class="keywordflow">return</span> 0;
<a name="l01048"></a>01048 }
<a name="l01049"></a>01049 
<a name="l01050"></a>01050 
<a name="l01051"></a>01051 <span class="comment">//This function removes all of a *SPECIFIC* type of message from the queue...</span>
<a name="l01052"></a><a class="code" href="class_game_code_app.html#b2">01052</a> <span class="keywordtype">int</span>     <a class="code" href="class_game_code_app.html#b2">GameCodeApp::EatSpecificMessages</a>( <a class="code" href="_d_x_u_tgui_8cpp.html#a45">UINT</a> msgType, <a class="code" href="classoptional.html">optional&lt;LPARAM&gt;</a> lParam, <a class="code" href="classoptional.html">optional&lt;WPARAM&gt;</a> wParam)
<a name="l01053"></a>01053 {
<a name="l01054"></a>01054         <span class="keywordtype">bool</span> done = <span class="keyword">false</span>;
<a name="l01055"></a>01055 
<a name="l01056"></a>01056         <span class="keywordflow">while</span> (!done)
<a name="l01057"></a>01057         {
<a name="l01058"></a>01058                 MSG msg;
<a name="l01059"></a>01059 
<a name="l01060"></a>01060                 <span class="keywordflow">if</span> ( PeekMessage( &amp;msg, NULL, msgType, msgType, PM_NOREMOVE ) )
<a name="l01061"></a>01061                 {
<a name="l01062"></a>01062                         <span class="keywordtype">bool</span> valid = <span class="keyword">true</span>;
<a name="l01063"></a>01063 
<a name="l01064"></a>01064                         <span class="keywordflow">if</span> (lParam.<a class="code" href="classoptional.html#a14">valid</a>())
<a name="l01065"></a>01065                         {
<a name="l01066"></a>01066                                 valid &amp;= (*lParam==msg.lParam);
<a name="l01067"></a>01067                         }
<a name="l01068"></a>01068 
<a name="l01069"></a>01069                         <span class="keywordflow">if</span> (wParam.<a class="code" href="classoptional.html#a14">valid</a>())
<a name="l01070"></a>01070                         {
<a name="l01071"></a>01071                                 valid &amp;= (*wParam==msg.wParam);
<a name="l01072"></a>01072                         }
<a name="l01073"></a>01073 
<a name="l01074"></a>01074                         <span class="keywordflow">if</span> (valid)
<a name="l01075"></a>01075                         {
<a name="l01076"></a>01076                                 <span class="comment">//Soak!</span>
<a name="l01077"></a>01077                                 GetMessage(&amp; msg, NULL, msgType, msgType);
<a name="l01078"></a>01078                         }
<a name="l01079"></a>01079                         <span class="keywordflow">else</span>
<a name="l01080"></a>01080                         {
<a name="l01081"></a>01081                                 done = <span class="keyword">true</span>;
<a name="l01082"></a>01082                         }
<a name="l01083"></a>01083                 }
<a name="l01084"></a>01084                 <span class="keywordflow">else</span>
<a name="l01085"></a>01085                 {
<a name="l01086"></a>01086                         done = <span class="keyword">true</span>;    <span class="comment">//No more messages!</span>
<a name="l01087"></a>01087                 }
<a name="l01088"></a>01088         }
<a name="l01089"></a>01089 
<a name="l01090"></a>01090         <span class="keywordflow">return</span> 0;
<a name="l01091"></a>01091 }
<a name="l01092"></a>01092 
<a name="l01093"></a>01093 
<a name="l01094"></a>01094 
<a name="l01095"></a>01095 
<a name="l01096"></a>01096 <span class="comment">//--------------------------------------------------------------------------------------</span>
<a name="l01097"></a>01097 <span class="comment">// This callback function will be called immediately after the Direct3D device has been </span>
<a name="l01098"></a>01098 <span class="comment">// reset, which will happen after a lost device scenario. This is the best location to </span>
<a name="l01099"></a>01099 <span class="comment">// create D3DPOOL_DEFAULT resources since these resources need to be reloaded whenever </span>
<a name="l01100"></a>01100 <span class="comment">// the device is lost. Resources created here should be released in the OnLostDevice </span>
<a name="l01101"></a>01101 <span class="comment">// callback. </span>
<a name="l01102"></a>01102 <span class="comment">//--------------------------------------------------------------------------------------</span>
<a name="l01103"></a><a class="code" href="class_game_code_app.html#e2">01103</a> <a class="code" href="_d_x_u_tgui_8cpp.html#a51">HRESULT</a> CALLBACK <a class="code" href="class_game_code_app.html#e2">GameCodeApp::OnResetDevice</a>(IDirect3DDevice9* pd3dDevice, <span class="keyword">const</span> D3DSURFACE_DESC*, <span class="keywordtype">void</span>* <a class="code" href="_d_x_u_tgui_8h.html#a14">pUserContext</a>  )
<a name="l01104"></a>01104 {
<a name="l01105"></a>01105         <a class="code" href="_d_x_u_tgui_8cpp.html#a51">HRESULT</a> hr;
<a name="l01106"></a>01106         <a class="code" href="dxstdafx_8h.html#a6">V_RETURN</a>( g_pApp-&gt;<a class="code" href="class_game_code_app.html#o0">m_pDialogResourceManager</a>-&gt;<a class="code" href="class_c_d_x_u_t_dialog_resource_manager.html#a3">OnResetDevice</a>( ) );
<a name="l01107"></a>01107 
<a name="l01108"></a>01108         <span class="keywordflow">if</span> (g_pApp-&gt;<a class="code" href="class_game_code_app.html#o1">m_pGame</a>)
<a name="l01109"></a>01109         {
<a name="l01110"></a>01110                 <a class="code" href="class_base_game.html">BaseGame</a> *pGame = g_pApp-&gt;<a class="code" href="class_game_code_app.html#o1">m_pGame</a>;
<a name="l01111"></a>01111                 <span class="keywordflow">for</span>(GameViewList::iterator i=pGame-&gt;<a class="code" href="class_base_game.html#p6">m_gameViews</a>.begin(); i!=pGame-&gt;<a class="code" href="class_base_game.html#p6">m_gameViews</a>.end(); ++i)
<a name="l01112"></a>01112                 {
<a name="l01113"></a>01113                         <a class="code" href="dxstdafx_8h.html#a6">V_RETURN</a> ( (*i)-&gt;VOnRestore() );
<a name="l01114"></a>01114                 }
<a name="l01115"></a>01115         }
<a name="l01116"></a>01116 
<a name="l01117"></a>01117         <span class="keywordflow">return</span> S_OK;
<a name="l01118"></a>01118 }
<a name="l01119"></a>01119 
<a name="l01120"></a>01120 
<a name="l01121"></a>01121 <span class="comment">//--------------------------------------------------------------------------------------</span>
<a name="l01122"></a>01122 <span class="comment">// This callback function will be called immediately after the Direct3D device has </span>
<a name="l01123"></a>01123 <span class="comment">// entered a lost state and before IDirect3DDevice9::Reset is called. Resources created</span>
<a name="l01124"></a>01124 <span class="comment">// in the OnResetDevice callback should be released here, which generally includes all </span>
<a name="l01125"></a>01125 <span class="comment">// D3DPOOL_DEFAULT resources. See the "Lost Devices" section of the documentation for </span>
<a name="l01126"></a>01126 <span class="comment">// information about lost devices.</span>
<a name="l01127"></a>01127 <span class="comment">//--------------------------------------------------------------------------------------</span>
<a name="l01128"></a><a class="code" href="class_game_code_app.html#e3">01128</a> <span class="keywordtype">void</span> CALLBACK <a class="code" href="class_game_code_app.html#e3">GameCodeApp::OnLostDevice</a>(<span class="keywordtype">void</span>* <a class="code" href="_d_x_u_tgui_8h.html#a14">pUserContext</a> )
<a name="l01129"></a>01129 {
<a name="l01130"></a>01130         <span class="keywordflow">if</span> (g_pApp-&gt;<a class="code" href="class_game_code_app.html#o0">m_pDialogResourceManager</a>)
<a name="l01131"></a>01131         {
<a name="l01132"></a>01132             g_pApp-&gt;<a class="code" href="class_game_code_app.html#o0">m_pDialogResourceManager</a>-&gt;<a class="code" href="class_c_d_x_u_t_dialog_resource_manager.html#a4">OnLostDevice</a>();
<a name="l01133"></a>01133         }
<a name="l01134"></a>01134 
<a name="l01135"></a>01135         <span class="keywordflow">if</span> (g_pApp-&gt;<a class="code" href="class_game_code_app.html#o1">m_pGame</a>)
<a name="l01136"></a>01136         {
<a name="l01137"></a>01137                 <a class="code" href="class_base_game.html">BaseGame</a> *pGame = g_pApp-&gt;<a class="code" href="class_game_code_app.html#o1">m_pGame</a>;
<a name="l01138"></a>01138                 <span class="keywordflow">for</span>(GameViewList::iterator i=pGame-&gt;<a class="code" href="class_base_game.html#p6">m_gameViews</a>.begin(); i!=pGame-&gt;<a class="code" href="class_base_game.html#p6">m_gameViews</a>.end(); ++i)
<a name="l01139"></a>01139                 {
<a name="l01140"></a>01140                         (*i)-&gt;VOnLostDevice();
<a name="l01141"></a>01141                 }
<a name="l01142"></a>01142         }
<a name="l01143"></a>01143 }
<a name="l01144"></a>01144 
<a name="l01145"></a>01145 
<a name="l01146"></a>01146 
<a name="l01147"></a>01147 
<a name="l01148"></a>01148 
<a name="l01149"></a>01149 <span class="comment">//--------------------------------------------------------------------------------------</span>
<a name="l01150"></a>01150 <span class="comment">// Called during device initialization, this code checks the device for some </span>
<a name="l01151"></a>01151 <span class="comment">// minimum set of capabilities, and rejects those that don't pass by returning false.</span>
<a name="l01152"></a>01152 <span class="comment">//--------------------------------------------------------------------------------------</span>
<a name="l01153"></a>01153 <span class="comment">//</span>
<a name="l01154"></a>01154 <span class="comment">//    Note: pUserContext added to comply with DirectX 9c - June 2005 Update</span>
<a name="l01155"></a>01155 <span class="comment">//</span>
<a name="l01156"></a><a class="code" href="class_game_code_app.html#e4">01156</a> <span class="keywordtype">bool</span> CALLBACK <a class="code" href="class_game_code_app.html#e4">GameCodeApp::IsDeviceAcceptable</a>( D3DCAPS9* pCaps, D3DFORMAT AdapterFormat, 
<a name="l01157"></a>01157                                   D3DFORMAT BackBufferFormat, <span class="keywordtype">bool</span> bWindowed, <span class="keywordtype">void</span>* <a class="code" href="_d_x_u_tgui_8h.html#a14">pUserContext</a> )
<a name="l01158"></a>01158 {
<a name="l01159"></a>01159     <span class="comment">// If your app needs 2.0 pixel shaders, comment in this check</span>
<a name="l01160"></a>01160     <span class="comment">// if( pCaps-&gt;PixelShaderVersion &lt; D3DPS_VERSION(2,0) )</span>
<a name="l01161"></a>01161     <span class="comment">//     return false;</span>
<a name="l01162"></a>01162 
<a name="l01163"></a>01163     <span class="comment">// Skip backbuffer formats that don't support alpha blending</span>
<a name="l01164"></a>01164     IDirect3D9* pD3D = <a class="code" href="_d_x_u_t_8cpp.html#a93">DXUTGetD3DObject</a>(); 
<a name="l01165"></a>01165     <span class="keywordflow">if</span>( FAILED( pD3D-&gt;CheckDeviceFormat( pCaps-&gt;AdapterOrdinal, pCaps-&gt;DeviceType,
<a name="l01166"></a>01166                     AdapterFormat, D3DUSAGE_QUERY_POSTPIXELSHADER_BLENDING, 
<a name="l01167"></a>01167                     D3DRTYPE_TEXTURE, BackBufferFormat ) ) )
<a name="l01168"></a>01168         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01169"></a>01169 
<a name="l01170"></a>01170     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01171"></a>01171 }
<a name="l01172"></a>01172 
<a name="l01173"></a>01173 
<a name="l01174"></a>01174 <span class="comment">//--------------------------------------------------------------------------------------</span>
<a name="l01175"></a>01175 <span class="comment">// This callback function is called immediately before a device is created to allow the </span>
<a name="l01176"></a>01176 <span class="comment">// application to modify the device settings. The supplied pDeviceSettings parameter </span>
<a name="l01177"></a>01177 <span class="comment">// contains the settings that the framework has selected for the new device, and the </span>
<a name="l01178"></a>01178 <span class="comment">// application can make any desired changes directly to this structure.  Note however that </span>
<a name="l01179"></a>01179 <span class="comment">// the sample framework will not correct invalid device settings so care must be taken </span>
<a name="l01180"></a>01180 <span class="comment">// to return valid device settings, otherwise IDirect3D9::CreateDevice() will fail.  </span>
<a name="l01181"></a>01181 <span class="comment">//--------------------------------------------------------------------------------------</span>
<a name="l01182"></a>01182 <span class="comment">//</span>
<a name="l01183"></a>01183 <span class="comment">//    Note: pUserContext added to comply with DirectX 9c - June 2005 Update</span>
<a name="l01184"></a>01184 <span class="comment">//</span>
<a name="l01185"></a><a class="code" href="class_game_code_app.html#e5">01185</a> <span class="keywordtype">bool</span> CALLBACK <a class="code" href="class_game_code_app.html#e5">GameCodeApp::ModifyDeviceSettings</a>( <a class="code" href="struct_d_x_u_t_device_settings.html">DXUTDeviceSettings</a>* pDeviceSettings, <span class="keyword">const</span> D3DCAPS9* pCaps, <span class="keywordtype">void</span>* <a class="code" href="_d_x_u_tgui_8h.html#a14">pUserContext</a> )
<a name="l01186"></a>01186 {
<a name="l01187"></a>01187     <span class="comment">// Debugging vertex shaders requires either REF or software vertex processing </span>
<a name="l01188"></a>01188     <span class="comment">// and debugging pixel shaders requires REF.  </span>
<a name="l01189"></a>01189 <span class="preprocessor">#ifdef DEBUG_VS</span>
<a name="l01190"></a>01190 <span class="preprocessor"></span>    <span class="keywordflow">if</span>( pDeviceSettings-&gt;<a class="code" href="struct_d_x_u_t_device_settings.html#o1">DeviceType</a> != D3DDEVTYPE_REF )
<a name="l01191"></a>01191     {
<a name="l01192"></a>01192         pDeviceSettings-&gt;<a class="code" href="struct_d_x_u_t_device_settings.html#o3">BehaviorFlags</a> &amp;= ~D3DCREATE_HARDWARE_VERTEXPROCESSING;
<a name="l01193"></a>01193         pDeviceSettings-&gt;<a class="code" href="struct_d_x_u_t_device_settings.html#o3">BehaviorFlags</a> &amp;= ~D3DCREATE_PUREDEVICE;
<a name="l01194"></a>01194         pDeviceSettings-&gt;<a class="code" href="struct_d_x_u_t_device_settings.html#o3">BehaviorFlags</a> |= D3DCREATE_SOFTWARE_VERTEXPROCESSING;
<a name="l01195"></a>01195     }
<a name="l01196"></a>01196 <span class="preprocessor">#endif</span>
<a name="l01197"></a>01197 <span class="preprocessor"></span><span class="preprocessor">#ifdef DEBUG_PS</span>
<a name="l01198"></a>01198 <span class="preprocessor"></span>    pDeviceSettings-&gt;<a class="code" href="struct_d_x_u_t_device_settings.html#o1">DeviceType</a> = D3DDEVTYPE_REF;
<a name="l01199"></a>01199 <span class="preprocessor">#endif</span>
<a name="l01200"></a>01200 <span class="preprocessor"></span>
<a name="l01201"></a>01201     <span class="comment">// For the first device created if its a REF device, optionally display a warning dialog box</span>
<a name="l01202"></a>01202     <span class="keyword">static</span> <span class="keywordtype">bool</span> s_bFirstTime = <span class="keyword">true</span>;
<a name="l01203"></a>01203     <span class="keywordflow">if</span>( s_bFirstTime )
<a name="l01204"></a>01204     {
<a name="l01205"></a>01205         s_bFirstTime = <span class="keyword">false</span>;
<a name="l01206"></a>01206         <span class="keywordflow">if</span>( pDeviceSettings-&gt;<a class="code" href="struct_d_x_u_t_device_settings.html#o1">DeviceType</a> == D3DDEVTYPE_REF )
<a name="l01207"></a>01207             <a class="code" href="_d_x_u_tmisc_8cpp.html#a22">DXUTDisplaySwitchingToREFWarning</a>();
<a name="l01208"></a>01208     }
<a name="l01209"></a>01209 
<a name="l01210"></a>01210     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01211"></a>01211 }
<a name="l01212"></a>01212 
<a name="l01213"></a>01213 
<a name="l01214"></a>01214 
<a name="l01215"></a>01215 
<a name="l01216"></a>01216 
<a name="l01217"></a>01217 
<a name="l01218"></a>01218 
<a name="l01219"></a>01219 <span class="comment">//--------------------------------------------------------------------------------------</span>
<a name="l01220"></a>01220 <span class="comment">// This callback function will be called once at the beginning of every frame. This is the</span>
<a name="l01221"></a>01221 <span class="comment">// best location for your application to handle updates to the scene, but is not </span>
<a name="l01222"></a>01222 <span class="comment">// intended to contain actual rendering calls, which should instead be placed in the </span>
<a name="l01223"></a>01223 <span class="comment">// OnFrameRender callback.  </span>
<a name="l01224"></a>01224 <span class="comment">//</span>
<a name="l01225"></a>01225 <span class="comment">// See Game Coding Complete - 2nd Edition - Chapter 6 - page 168</span>
<a name="l01226"></a>01226 <span class="comment">//--------------------------------------------------------------------------------------</span>
<a name="l01227"></a><a class="code" href="class_game_code_app.html#e6">01227</a> <span class="keywordtype">void</span> CALLBACK <a class="code" href="class_game_code_app.html#e6">GameCodeApp::OnUpdateGame</a>( IDirect3DDevice9* pd3dDevice, <span class="keywordtype">double</span> fTime, <span class="keywordtype">float</span> fElapsedTime, <span class="keywordtype">void</span>* <a class="code" href="_d_x_u_tgui_8h.html#a14">pUserContext</a>  )
<a name="l01228"></a>01228 {
<a name="l01229"></a>01229         <span class="keywordflow">if</span> (g_pApp-&gt;<a class="code" href="class_game_code_app.html#a8">HasModalDialog</a>())
<a name="l01230"></a>01230         {       
<a name="l01231"></a>01231                 <span class="comment">// don't update the game if a modal dialog is up.</span>
<a name="l01232"></a>01232                 <span class="keywordflow">return</span>;
<a name="l01233"></a>01233         }
<a name="l01234"></a>01234 
<a name="l01235"></a>01235         <span class="keywordflow">if</span> (g_pApp-&gt;<a class="code" href="class_game_code_app.html#p4">m_bQuitting</a>)
<a name="l01236"></a>01236         {
<a name="l01237"></a>01237                 PostMessage(g_pApp-&gt;<a class="code" href="class_game_code_app.html#a4">GetHwnd</a>(), WM_CLOSE, 0, 0);         
<a name="l01238"></a>01238         }
<a name="l01239"></a>01239 
<a name="l01240"></a>01240         <span class="keywordflow">if</span> (g_pApp-&gt;<a class="code" href="class_game_code_app.html#o1">m_pGame</a>)
<a name="l01241"></a>01241         {
<a name="l01242"></a>01242                 <a class="code" href="_trigger_system_8cpp.html#a11">safeTickEventManager</a>( 20 ); <span class="comment">// allow event queue to process for up to 20 ms</span>
<a name="l01243"></a>01243 
<a name="l01244"></a>01244                 <span class="keywordflow">if</span> (g_pApp-&gt;<a class="code" href="class_game_code_app.html#o6">m_pBaseSocketManager</a>)
<a name="l01245"></a>01245                         g_pApp-&gt;<a class="code" href="class_game_code_app.html#o6">m_pBaseSocketManager</a>-&gt;<a class="code" href="class_base_socket_manager.html#a2">DoSelect</a>(0);      <span class="comment">// pause 0 microseconds</span>
<a name="l01246"></a>01246 
<a name="l01247"></a>01247                 g_pApp-&gt;<a class="code" href="class_game_code_app.html#o1">m_pGame</a>-&gt;<a class="code" href="class_base_game.html#a10">VOnUpdate</a>(fTime, fElapsedTime);
<a name="l01248"></a>01248         }
<a name="l01249"></a>01249 }
<a name="l01250"></a>01250 
<a name="l01251"></a>01251 
<a name="l01252"></a>01252 <span class="comment">//--------------------------------------------------------------------------------------</span>
<a name="l01253"></a>01253 <span class="comment">// This callback function will be called at the end of every frame to perform all the </span>
<a name="l01254"></a>01254 <span class="comment">// rendering calls for the scene, and it will also be called if the window needs to be </span>
<a name="l01255"></a>01255 <span class="comment">// repainted. After this function has returned, the sample framework will call </span>
<a name="l01256"></a>01256 <span class="comment">// IDirect3DDevice9::Present to display the contents of the next buffer in the swap chain</span>
<a name="l01257"></a>01257 <span class="comment">//</span>
<a name="l01258"></a>01258 <span class="comment">// See Game Coding Complete - 2nd Edition - Chapter 6 - page 169</span>
<a name="l01259"></a>01259 <span class="comment">//--------------------------------------------------------------------------------------</span>
<a name="l01260"></a><a class="code" href="class_game_code_app.html#e7">01260</a> <span class="keywordtype">void</span> CALLBACK <a class="code" href="class_game_code_app.html#e7">GameCodeApp::OnRender</a>( IDirect3DDevice9* pd3dDevice, <span class="keywordtype">double</span> fTime, <span class="keywordtype">float</span> fElapsedTime, <span class="keywordtype">void</span>* <a class="code" href="_d_x_u_tgui_8h.html#a14">pUserContext</a>  )
<a name="l01261"></a>01261 {
<a name="l01262"></a>01262         <a class="code" href="class_base_game.html">BaseGame</a> *pGame = g_pApp-&gt;<a class="code" href="class_game_code_app.html#o1">m_pGame</a>;
<a name="l01263"></a>01263 
<a name="l01264"></a>01264         <span class="keywordflow">for</span>(GameViewList::iterator i=pGame-&gt;<a class="code" href="class_base_game.html#p6">m_gameViews</a>.begin(); i!=pGame-&gt;<a class="code" href="class_base_game.html#p6">m_gameViews</a>.end(); ++i)
<a name="l01265"></a>01265         {
<a name="l01266"></a>01266                 (*i)-&gt;VOnRender(fTime, fElapsedTime);
<a name="l01267"></a>01267         }
<a name="l01268"></a>01268 
<a name="l01269"></a>01269         g_pApp-&gt;<a class="code" href="class_game_code_app.html#o1">m_pGame</a>-&gt;<a class="code" href="class_base_game.html#a12">VRenderDiagnostics</a>();
<a name="l01270"></a>01270 }
<a name="l01271"></a>01271 
<a name="l01272"></a>01272 
<a name="l01273"></a>01273 
<a name="l01274"></a>01274 
<a name="l01275"></a>01275 
<a name="l01276"></a><a class="code" href="class_game_code_app.html#e8">01276</a> <a class="code" href="_d_x_u_tgui_8cpp.html#a51">HRESULT</a> CALLBACK <a class="code" href="class_game_code_app.html#e8">GameCodeApp::OnCreateDevice</a>( IDirect3DDevice9* pd3dDevice, <span class="keyword">const</span> D3DSURFACE_DESC* pBackBufferSurfaceDesc, <span class="keywordtype">void</span>* <a class="code" href="_d_x_u_tgui_8h.html#a14">pUserContext</a> )
<a name="l01277"></a>01277 {
<a name="l01278"></a>01278         <a class="code" href="_d_x_u_tgui_8cpp.html#a51">HRESULT</a> hr;
<a name="l01279"></a>01279     <a class="code" href="dxstdafx_8h.html#a6">V_RETURN</a>( g_pApp-&gt;<a class="code" href="class_game_code_app.html#o0">m_pDialogResourceManager</a>-&gt;<a class="code" href="class_c_d_x_u_t_dialog_resource_manager.html#a2">OnCreateDevice</a>( pd3dDevice ) );
<a name="l01280"></a>01280         <span class="keywordflow">return</span> S_OK;
<a name="l01281"></a>01281 }
<a name="l01282"></a>01282 
<a name="l01283"></a><a class="code" href="class_game_code_app.html#e9">01283</a> <span class="keywordtype">void</span> CALLBACK <a class="code" href="class_game_code_app.html#e9">GameCodeApp::OnDestroyDevice</a>( <span class="keywordtype">void</span>* <a class="code" href="_d_x_u_tgui_8h.html#a14">pUserContext</a> )
<a name="l01284"></a>01284 {
<a name="l01285"></a>01285         <span class="comment">/***</span>
<a name="l01286"></a>01286 <span class="comment">        for(GameViewList::iterator i=pGame-&gt;m_gameViews.begin(); i!=pGame-&gt;m_gameViews.end(); ++i)</span>
<a name="l01287"></a>01287 <span class="comment">        {</span>
<a name="l01288"></a>01288 <span class="comment">                (*i)-&gt;VOnDestroyDevice(fTime, fElapsedTime);</span>
<a name="l01289"></a>01289 <span class="comment">        }</span>
<a name="l01290"></a>01290 <span class="comment">        ***/</span>
<a name="l01291"></a>01291         <span class="keywordflow">if</span> (g_pApp-&gt;<a class="code" href="class_game_code_app.html#o0">m_pDialogResourceManager</a>)
<a name="l01292"></a>01292         {
<a name="l01293"></a>01293                 g_pApp-&gt;<a class="code" href="class_game_code_app.html#o0">m_pDialogResourceManager</a>-&gt;<a class="code" href="class_c_d_x_u_t_dialog_resource_manager.html#a5">OnDestroyDevice</a>( );
<a name="l01294"></a>01294         }
<a name="l01295"></a>01295 }
<a name="l01296"></a>01296 
<a name="l01297"></a>01297 
<a name="l01298"></a>01298 
<a name="l01299"></a>01299 
<a name="l01300"></a>01300 <span class="comment">//========================================================================</span>
<a name="l01301"></a>01301 <span class="comment">//</span>
<a name="l01302"></a>01302 <span class="comment">// BaseGame implementation</span>
<a name="l01303"></a>01303 <span class="comment">//</span>
<a name="l01304"></a>01304 <span class="comment">//========================================================================</span>
<a name="l01305"></a>01305 
<a name="l01306"></a>01306 <span class="preprocessor">#include &lt;mmsystem.h&gt;</span>
<a name="l01307"></a>01307 <span class="preprocessor">#include "<a class="code" href="_c_process_8h.html">MainLoop\CProcess.h</a>"</span>
<a name="l01308"></a>01308 
<a name="l01309"></a>01309 <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="_game_code_8cpp.html#a3">SCREEN_REFRESH_RATE</a>(1000/60);
<a name="l01310"></a>01310 
<a name="l01311"></a>01311 
<a name="l01312"></a><a class="code" href="class_base_game.html#a0">01312</a> <a class="code" href="class_base_game.html#a0">BaseGame::BaseGame</a>(<span class="keyword">struct</span> <a class="code" href="struct_game_options.html">GameOptions</a> <span class="keyword">const</span> &amp;options)
<a name="l01313"></a>01313 {
<a name="l01314"></a>01314         <a class="code" href="class_base_game.html#p3">m_LastActorId</a> = 0;
<a name="l01315"></a>01315         <a class="code" href="class_base_game.html#p0">m_pProcessManager</a> = <a class="code" href="_game_code_std_8h.html#a2">GCC_NEW</a> <a class="code" href="class_c_process_manager.html">CProcessManager</a>;
<a name="l01316"></a>01316         <a class="code" href="class_base_game.html#p1">m_random</a>.<a class="code" href="class_c_random.html#a5">Randomize</a>();
<a name="l01317"></a>01317         <a class="code" href="class_base_game.html#p4">m_State</a> = <a class="code" href="_game_code_8h.html#a17a11">BGS_Initializing</a>;
<a name="l01318"></a>01318         <a class="code" href="class_base_game.html#p5">m_ExpectedPlayers</a> = options.<a class="code" href="struct_game_options.html#o10">m_expectedPlayers</a>;
<a name="l01319"></a>01319 }
<a name="l01320"></a>01320 
<a name="l01321"></a>01321 
<a name="l01322"></a><a class="code" href="class_base_game.html#a1">01322</a> <a class="code" href="class_base_game.html#a1">BaseGame::~BaseGame</a>()
<a name="l01323"></a>01323 {
<a name="l01324"></a>01324         <a class="code" href="class_base_game.html#p0">m_pProcessManager</a>-&gt;<a class="code" href="class_c_process_manager.html#a1">DeleteProcessList</a>();
<a name="l01325"></a>01325         <a class="code" href="dxstdafx_8h.html#a7">SAFE_DELETE</a>(<a class="code" href="class_base_game.html#p0">m_pProcessManager</a>);
<a name="l01326"></a>01326 
<a name="l01327"></a>01327         assert (<a class="code" href="class_base_game.html#p2">m_ActorList</a>.empty() &amp;&amp; _T(<span class="stringliteral">"You should destroy the actor list in the inherited class!"</span>) );
<a name="l01328"></a>01328 }
<a name="l01329"></a>01329 
<a name="l01330"></a>01330 <span class="comment">//</span>
<a name="l01331"></a>01331 <span class="comment">// BaseGame::VAddActor                          - Chapter 19, page 750</span>
<a name="l01332"></a>01332 <span class="comment">//</span>
<a name="l01333"></a><a class="code" href="class_base_game.html#a5">01333</a> <span class="keywordtype">void</span> <a class="code" href="class_base_game.html#a5">BaseGame::VAddActor</a>(shared_ptr&lt;IActor&gt; actor, <a class="code" href="struct_actor_params.html">ActorParams</a> *p)
<a name="l01334"></a>01334 {
<a name="l01335"></a>01335         <a class="code" href="class_base_game.html#p2">m_ActorList</a>[<a class="code" href="class_base_game.html#p3">m_LastActorId</a>] = actor;
<a name="l01336"></a>01336         actor-&gt;VSetID(<a class="code" href="class_base_game.html#p3">m_LastActorId</a>);
<a name="l01337"></a>01337         p-&gt;<a class="code" href="struct_actor_params.html#o1">m_Id</a> = <a class="code" href="class_base_game.html#p3">m_LastActorId</a>;
<a name="l01338"></a>01338         <a class="code" href="_trigger_system_8cpp.html#a9">safeQueEvent</a>( <a class="code" href="_trigger_system_8h.html#a4">EventPtr</a>(<a class="code" href="_game_code_std_8h.html#a2">GCC_NEW</a> <a class="code" href="class_evt___new___actor.html">Evt_New_Actor</a>( <a class="code" href="class_base_game.html#p3">m_LastActorId</a>, p )) );
<a name="l01339"></a>01339         ++m_LastActorId;
<a name="l01340"></a>01340 }
<a name="l01341"></a>01341 
<a name="l01342"></a>01342 
<a name="l01343"></a><a class="code" href="class_base_game.html#a7">01343</a> <span class="keywordtype">void</span> <a class="code" href="class_base_game.html#a7">BaseGame::VRemoveActor</a>(<a class="code" href="interfaces_8h.html#a0">ActorId</a> <span class="keywordtype">id</span>)
<a name="l01344"></a>01344 {
<a name="l01345"></a>01345         <a class="code" href="class_base_game.html#p2">m_ActorList</a>.erase(<span class="keywordtype">id</span>);
<a name="l01346"></a>01346 }
<a name="l01347"></a>01347 
<a name="l01348"></a>01348 
<a name="l01349"></a><a class="code" href="class_base_game.html#a8">01349</a> <span class="keywordtype">void</span> <a class="code" href="class_base_game.html#a8">BaseGame::VMoveActor</a>(<span class="keyword">const</span> <a class="code" href="interfaces_8h.html#a0">ActorId</a> <span class="keywordtype">id</span>, <a class="code" href="class_mat4x4.html">Mat4x4</a> <span class="keyword">const</span> &amp;mat)
<a name="l01350"></a>01350 {
<a name="l01351"></a>01351         shared_ptr&lt;IActor&gt; pActor = <a class="code" href="class_base_game.html#a6">VGetActor</a>(<span class="keywordtype">id</span>);
<a name="l01352"></a>01352         <span class="keywordflow">if</span> (pActor)
<a name="l01353"></a>01353         {
<a name="l01354"></a>01354                 pActor-&gt;VSetMat(mat);
<a name="l01355"></a>01355         }
<a name="l01356"></a>01356 }
<a name="l01357"></a>01357 
<a name="l01358"></a><a class="code" href="class_base_game.html#a6">01358</a> shared_ptr&lt;IActor&gt; <a class="code" href="class_base_game.html#a6">BaseGame::VGetActor</a>(<span class="keyword">const</span> <a class="code" href="interfaces_8h.html#a0">ActorId</a> <span class="keywordtype">id</span>)
<a name="l01359"></a>01359 {
<a name="l01360"></a>01360         ActorMap::iterator i = <a class="code" href="class_base_game.html#p2">m_ActorList</a>.find(<span class="keywordtype">id</span>);
<a name="l01361"></a>01361         <span class="keywordflow">if</span> (i==<a class="code" href="class_base_game.html#p2">m_ActorList</a>.end())
<a name="l01362"></a>01362         {
<a name="l01363"></a>01363                 shared_ptr&lt;IActor&gt; null;
<a name="l01364"></a>01364                 <span class="keywordflow">return</span> null;
<a name="l01365"></a>01365         }
<a name="l01366"></a>01366 
<a name="l01367"></a>01367         <span class="keywordflow">return</span> (*i).second;
<a name="l01368"></a>01368 }
<a name="l01369"></a>01369 
<a name="l01370"></a><a class="code" href="class_base_game.html#a10">01370</a> <span class="keywordtype">void</span> <a class="code" href="class_base_game.html#a10">BaseGame::VOnUpdate</a>(<span class="keywordtype">float</span> time, <span class="keywordtype">float</span> elapsedTime)
<a name="l01371"></a>01371 {
<a name="l01372"></a>01372         <span class="keywordtype">int</span> deltaMilliseconds = <a class="code" href="_d_x_u_tgui_8cpp.html#a37">int</a>(elapsedTime * 1000.0f);
<a name="l01373"></a>01373 
<a name="l01374"></a>01374         <span class="keywordflow">switch</span>(<a class="code" href="class_base_game.html#p4">m_State</a>)
<a name="l01375"></a>01375         {
<a name="l01376"></a>01376                 <span class="keywordflow">case</span> <a class="code" href="_game_code_8h.html#a17a11">BGS_Initializing</a>:
<a name="l01377"></a>01377                         <span class="comment">// If we get to here we're ready to attach players</span>
<a name="l01378"></a>01378                         <a class="code" href="class_base_game.html#a11">VChangeState</a>(<a class="code" href="_game_code_8h.html#a17a12">BGS_LoadingGameEnvironment</a>);
<a name="l01379"></a>01379                         <span class="keywordflow">break</span>;
<a name="l01380"></a>01380 
<a name="l01381"></a>01381                 <span class="keywordflow">case</span> <a class="code" href="_game_code_8h.html#a17a12">BGS_LoadingGameEnvironment</a>:
<a name="l01382"></a>01382                         <span class="keywordflow">if</span> (g_pApp-&gt;<a class="code" href="class_game_code_app.html#a20">VLoadGame</a>())
<a name="l01383"></a>01383                         {       
<a name="l01384"></a>01384                                 <a class="code" href="class_base_game.html#a11">VChangeState</a>(<a class="code" href="_game_code_8h.html#a17a13">BGS_WaitingForPlayers</a>);
<a name="l01385"></a>01385                         }
<a name="l01386"></a>01386                         <span class="keywordflow">else</span>
<a name="l01387"></a>01387                         {
<a name="l01388"></a>01388                                 assert(0 &amp;&amp; _T(<span class="stringliteral">"The game failed to load."</span>));
<a name="l01389"></a>01389                                 g_pApp-&gt;<a class="code" href="class_game_code_app.html#a24">AbortGame</a>();
<a name="l01390"></a>01390                         }
<a name="l01391"></a>01391                         <span class="keywordflow">break</span>;
<a name="l01392"></a>01392 
<a name="l01393"></a>01393                 <span class="keywordflow">case</span> <a class="code" href="_game_code_8h.html#a17a13">BGS_WaitingForPlayers</a>:
<a name="l01394"></a>01394                         <span class="keywordflow">if</span> (<a class="code" href="class_base_game.html#p5">m_ExpectedPlayers</a> == <a class="code" href="class_base_game.html#p6">m_gameViews</a>.size() )
<a name="l01395"></a>01395                         {
<a name="l01396"></a>01396                                 <a class="code" href="class_base_game.html#a11">VChangeState</a>(<a class="code" href="_game_code_8h.html#a17a14">BGS_Running</a>);
<a name="l01397"></a>01397                         }
<a name="l01398"></a>01398                         <span class="keywordflow">break</span>;
<a name="l01399"></a>01399 
<a name="l01400"></a>01400                 <span class="keywordflow">case</span> <a class="code" href="_game_code_8h.html#a17a14">BGS_Running</a>:
<a name="l01401"></a>01401                         <a class="code" href="class_base_game.html#p0">m_pProcessManager</a>-&gt;<a class="code" href="class_c_process_manager.html#a0">UpdateProcesses</a>(deltaMilliseconds);
<a name="l01402"></a>01402                         <span class="keywordflow">break</span>;
<a name="l01403"></a>01403 
<a name="l01404"></a>01404                 <span class="keywordflow">default</span>:
<a name="l01405"></a>01405                         assert(0 &amp;&amp; _T(<span class="stringliteral">"Unrecognized state."</span>));
<a name="l01406"></a>01406         }
<a name="l01407"></a>01407 
<a name="l01408"></a>01408         <span class="keywordflow">for</span>(GameViewList::iterator i=<a class="code" href="class_base_game.html#p6">m_gameViews</a>.begin(); i!=<a class="code" href="class_base_game.html#p6">m_gameViews</a>.end(); ++i)
<a name="l01409"></a>01409         {
<a name="l01410"></a>01410                 (*i)-&gt;VOnUpdate( deltaMilliseconds );
<a name="l01411"></a>01411         }
<a name="l01412"></a>01412 }
<a name="l01413"></a>01413 
<a name="l01414"></a><a class="code" href="class_base_game.html#a11">01414</a> <span class="keywordtype">void</span> <a class="code" href="class_base_game.html#a11">BaseGame::VChangeState</a>(<a class="code" href="_game_code_8h.html#a17">BaseGameState</a> newState)
<a name="l01415"></a>01415 {
<a name="l01416"></a>01416         <a class="code" href="class_base_game.html#p4">m_State</a> = newState;
<a name="l01417"></a>01417         <a class="code" href="_trigger_system_8cpp.html#a9">safeQueEvent</a>( <a class="code" href="_trigger_system_8h.html#a4">EventPtr</a>(<a class="code" href="_game_code_std_8h.html#a2">GCC_NEW</a> <a class="code" href="class_evt___game___state.html">Evt_Game_State</a>(<a class="code" href="class_base_game.html#p4">m_State</a>)) );
<a name="l01418"></a>01418 }
<a name="l01419"></a>01419 
<a name="l01420"></a>01420 
<a name="l01421"></a>01421 
<a name="l01422"></a>01422 
<a name="l01423"></a>01423 
<a name="l01424"></a>01424 
<a name="l01425"></a><a class="code" href="class_base_game.html#a2">01425</a> <span class="keywordtype">void</span> <a class="code" href="class_base_game.html#a2">BaseGame::TogglePause</a>(<span class="keywordtype">bool</span> active)
<a name="l01426"></a>01426 {
<a name="l01427"></a>01427         <span class="comment">//TODO This whole bot of code belongs in the view, not the game!</span>
<a name="l01428"></a>01428         <span class="comment">// AND it should fire off a pause event to all listeners.</span>
<a name="l01429"></a>01429 
<a name="l01430"></a>01430         <span class="comment">// Pause or resume audio        </span>
<a name="l01431"></a>01431         <span class="keywordflow">if</span> ( active )
<a name="l01432"></a>01432         {
<a name="l01433"></a>01433                 <span class="comment">//ResetTimer();</span>
<a name="l01434"></a>01434                 <span class="keywordflow">if</span> (<a class="code" href="_c_audio_8cpp.html#a0">g_Audio</a>) 
<a name="l01435"></a>01435                         g_Audio-&gt;VPauseAllSounds();
<a name="l01436"></a>01436         }
<a name="l01437"></a>01437         <span class="keywordflow">else</span>
<a name="l01438"></a>01438         {
<a name="l01439"></a>01439                 <span class="keywordflow">if</span> (<a class="code" href="_c_audio_8cpp.html#a0">g_Audio</a>)
<a name="l01440"></a>01440                         <a class="code" href="_c_audio_8cpp.html#a0">g_Audio</a>-&gt;<a class="code" href="class_c_audio.html#a3">VResumeAllSounds</a>();
<a name="l01441"></a>01441                 <span class="comment">//SaveBackground();</span>
<a name="l01442"></a>01442         }
<a name="l01443"></a>01443 }
<a name="l01444"></a>01444 
<a name="l01445"></a>01445 
<a name="l01446"></a><a class="code" href="class_base_game.html#a4">01446</a> <span class="keywordtype">void</span> <a class="code" href="class_base_game.html#a4">BaseGame::VAddView</a>(shared_ptr&lt;IGameView&gt; pView)
<a name="l01447"></a>01447 {
<a name="l01448"></a>01448         <span class="keywordtype">int</span> viewId = static_cast&lt;int&gt;(<a class="code" href="class_base_game.html#p6">m_gameViews</a>.size());
<a name="l01449"></a>01449         <a class="code" href="class_base_game.html#p6">m_gameViews</a>.push_back(pView);
<a name="l01450"></a>01450         pView-&gt;VOnAttach(viewId, <a class="code" href="classoptional__empty.html">optional_empty</a>());
<a name="l01451"></a>01451 }
<a name="l01452"></a>01452 
<a name="l01453"></a>01453 <span class="comment">// This is always called as a result of reciveing a packet</span>
<a name="l01454"></a>01454 <span class="comment">// from a remote server</span>
<a name="l01455"></a>01455 
<a name="l01456"></a><a class="code" href="class_base_game.html#a3">01456</a> <span class="keywordtype">void</span> <a class="code" href="class_base_game.html#a3">BaseGame::SetPlayer</a>(<a class="code" href="interfaces_8h.html#a14">GameViewType</a> type, <a class="code" href="interfaces_8h.html#a1">GameViewId</a> viewId, <a class="code" href="interfaces_8h.html#a0">ActorId</a> aid)
<a name="l01457"></a>01457 {
<a name="l01458"></a>01458         <span class="keywordflow">for</span>(GameViewList::iterator i=<a class="code" href="class_base_game.html#p6">m_gameViews</a>.begin(); i!=<a class="code" href="class_base_game.html#p6">m_gameViews</a>.end(); ++i)
<a name="l01459"></a>01459         {
<a name="l01460"></a>01460                 <span class="keywordflow">if</span> ((*i)-&gt;VGetType()==type)
<a name="l01461"></a>01461                 {
<a name="l01462"></a>01462                         (*i)-&gt;VOnAttach(viewId, aid);
<a name="l01463"></a>01463                         <span class="keywordflow">return</span>;
<a name="l01464"></a>01464                 }
<a name="l01465"></a>01465         }
<a name="l01466"></a>01466 }
<a name="l01467"></a>01467 
<a name="l01468"></a>01468 <span class="comment">//</span>
<a name="l01469"></a>01469 <span class="comment">// class CMessageBox::OnGUIEvent - Chapter 9, page 276</span>
<a name="l01470"></a>01470 <span class="comment">//</span>
<a name="l01471"></a>01471 <span class="comment">//    Note: pUserContext added to comply with DirectX 9c - June 2005 Update</span>
<a name="l01472"></a>01472 <span class="comment">//</span>
<a name="l01473"></a><a class="code" href="class_c_message_box.html#e0">01473</a> <span class="keywordtype">void</span> CALLBACK <a class="code" href="class_c_message_box.html#e0">CMessageBox::OnGUIEvent</a>( <a class="code" href="_d_x_u_tgui_8cpp.html#a45">UINT</a> nEvent, <span class="keywordtype">int</span> <a class="code" href="_d_x_u_tgui_8h.html#a12">nControlID</a>, <a class="code" href="class_c_d_x_u_t_control.html">CDXUTControl</a>* <a class="code" href="_d_x_u_tgui_8h.html#a13">pControl</a>, <span class="keywordtype">void</span> *<a class="code" href="_d_x_u_tgui_8h.html#a14">pUserContext</a> )
<a name="l01474"></a>01474 {
<a name="l01475"></a>01475         PostMessage(g_pApp-&gt;<a class="code" href="class_game_code_app.html#a4">GetHwnd</a>(), <a class="code" href="_game_code_8h.html#a1">MSG_END_MODAL</a>, 0, nControlID);           
<a name="l01476"></a>01476 }
<a name="l01477"></a>01477 
<a name="l01478"></a>01478 <span class="comment">//</span>
<a name="l01479"></a>01479 <span class="comment">// class CMessageBox::CMessageBox - Chapter 9, page 272</span>
<a name="l01480"></a>01480 <span class="comment">//</span>
<a name="l01481"></a><a class="code" href="class_c_message_box.html#a0">01481</a> <a class="code" href="class_c_message_box.html#a0">CMessageBox::CMessageBox</a>(std::wstring msg, std::wstring title, <span class="keywordtype">int</span> buttonFlags)
<a name="l01482"></a>01482 {
<a name="l01483"></a>01483         <span class="comment">// Initialize dialogs</span>
<a name="l01484"></a>01484         <a class="code" href="class_c_message_box.html#p0">m_UI</a>.<a class="code" href="class_c_d_x_u_t_dialog.html#a2">Init</a>( g_pApp-&gt;<a class="code" href="class_game_code_app.html#o0">m_pDialogResourceManager</a> );
<a name="l01485"></a>01485     <a class="code" href="class_c_message_box.html#p0">m_UI</a>.<a class="code" href="class_c_d_x_u_t_dialog.html#a57">SetCallback</a>( <a class="code" href="class_c_message_box.html#e0">OnGUIEvent</a> ); 
<a name="l01486"></a>01486 
<a name="l01487"></a>01487         <span class="comment">// Find the dimensions of the message</span>
<a name="l01488"></a>01488         RECT rc;
<a name="l01489"></a>01489         SetRect( &amp;rc, 0,0,0,0);
<a name="l01490"></a>01490         <a class="code" href="class_c_message_box.html#p0">m_UI</a>.<a class="code" href="class_c_d_x_u_t_dialog.html#a38">CalcTextRect</a>( msg.c_str(), <a class="code" href="class_c_message_box.html#p0">m_UI</a>.<a class="code" href="class_c_d_x_u_t_dialog.html#a32">GetDefaultElement</a>(<a class="code" href="_d_x_u_tgui_8h.html#a32a16">DXUT_CONTROL_STATIC</a>,0), &amp;rc );
<a name="l01491"></a>01491     <span class="keywordtype">int</span> msgWidth = rc.right - rc.left;
<a name="l01492"></a>01492     <span class="keywordtype">int</span> msgHeight = rc.bottom - rc.top;
<a name="l01493"></a>01493 
<a name="l01494"></a>01494         <span class="keywordtype">int</span> numButtons = 2;
<a name="l01495"></a>01495         <span class="keywordflow">if</span> ( (buttonFlags == MB_ABORTRETRYIGNORE) ||
<a name="l01496"></a>01496                 (buttonFlags == MB_CANCELTRYCONTINUE) ||
<a name="l01497"></a>01497                 (buttonFlags == MB_CANCELTRYCONTINUE) )
<a name="l01498"></a>01498         {
<a name="l01499"></a>01499                 numButtons = 3;
<a name="l01500"></a>01500         }
<a name="l01501"></a>01501         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buttonFlags == MB_OK)
<a name="l01502"></a>01502         {
<a name="l01503"></a>01503                 numButtons = 1;
<a name="l01504"></a>01504         }
<a name="l01505"></a>01505 
<a name="l01506"></a>01506         <span class="keywordtype">int</span> btnWidth = 125;
<a name="l01507"></a>01507         <span class="keywordtype">int</span> btnHeight = 22;
<a name="l01508"></a>01508 
<a name="l01509"></a>01509         <span class="keywordtype">int</span> border = 35;
<a name="l01510"></a>01510         <a class="code" href="class_c_base_u_i.html#p2">m_Width</a> = <a class="code" href="_prime_search_8cpp.html#a0">max</a>(msgWidth + 2 * border, btnWidth + 2 * border);
<a name="l01511"></a>01511         <a class="code" href="class_c_base_u_i.html#p3">m_Height</a> = msgHeight + (numButtons * (btnHeight+border) ) + (2 * border);
<a name="l01512"></a>01512 
<a name="l01513"></a>01513         <a class="code" href="class_c_base_u_i.html#p0">m_PosX</a> = (<a class="code" href="_d_x_u_t_8cpp.html#a95">DXUTGetBackBufferSurfaceDesc</a>()-&gt;Width-<a class="code" href="class_c_base_u_i.html#p2">m_Width</a>)/2;
<a name="l01514"></a>01514         <a class="code" href="class_c_base_u_i.html#p1">m_PosY</a> = (<a class="code" href="_d_x_u_t_8cpp.html#a95">DXUTGetBackBufferSurfaceDesc</a>()-&gt;Height-<a class="code" href="class_c_base_u_i.html#p3">m_Height</a>)/2;
<a name="l01515"></a>01515         <a class="code" href="class_c_message_box.html#p0">m_UI</a>.<a class="code" href="class_c_d_x_u_t_dialog.html#a51">SetLocation</a>( <a class="code" href="class_c_base_u_i.html#p0">m_PosX</a>, <a class="code" href="class_c_base_u_i.html#p1">m_PosY</a> );
<a name="l01516"></a>01516 
<a name="l01517"></a>01517         <a class="code" href="class_c_message_box.html#p0">m_UI</a>.<a class="code" href="class_c_d_x_u_t_dialog.html#a52">SetSize</a>( <a class="code" href="class_c_base_u_i.html#p2">m_Width</a>, <a class="code" href="class_c_base_u_i.html#p3">m_Height</a> );
<a name="l01518"></a>01518         <a class="code" href="class_c_message_box.html#p0">m_UI</a>.<a class="code" href="class_c_d_x_u_t_dialog.html#a44">SetBackgroundColors</a>(<a class="code" href="_game_code_std_8h.html#a24">g_Gray40</a>);
<a name="l01519"></a>01519 
<a name="l01520"></a>01520         <span class="comment">/***</span>
<a name="l01521"></a>01521 <span class="comment">        RECT bg;</span>
<a name="l01522"></a>01522 <span class="comment">        SetRect( &amp;bg, 0, 0, m_Width, m_Height );</span>
<a name="l01523"></a>01523 <span class="comment">        m_UI.AddStatic( -1, _T(""), bg.left, bg.top, bg.right, bg.bottom);</span>
<a name="l01524"></a>01524 <span class="comment">        CDXUTStatic *pCreated = m_UI.GetStatic(-1);</span>
<a name="l01525"></a>01525 <span class="comment">        if (pCreated) </span>
<a name="l01526"></a>01526 <span class="comment">        {</span>
<a name="l01527"></a>01527 <span class="comment">                CDXUTElement *element = pCreated-&gt;GetElement(0);</span>
<a name="l01528"></a>01528 <span class="comment">                element-&gt;SetTexture( 0, &amp;bg );</span>
<a name="l01529"></a>01529 <span class="comment">        }</span>
<a name="l01530"></a>01530 <span class="comment">        ***/</span>
<a name="l01531"></a>01531 
<a name="l01532"></a>01532         <span class="keywordtype">int</span> iY = border; 
<a name="l01533"></a>01533         <span class="keywordtype">int</span> iX = (<a class="code" href="class_c_base_u_i.html#p2">m_Width</a> - msgWidth) / 2; 
<a name="l01534"></a>01534 
<a name="l01535"></a>01535         <a class="code" href="class_c_message_box.html#p0">m_UI</a>.<a class="code" href="class_c_d_x_u_t_dialog.html#a4">AddStatic</a>( 0, msg.c_str(), iX, iY, msgWidth, msgHeight);
<a name="l01536"></a>01536 
<a name="l01537"></a>01537         iX = (<a class="code" href="class_c_base_u_i.html#p2">m_Width</a> - btnWidth) / 2;
<a name="l01538"></a>01538         iY = <a class="code" href="class_c_base_u_i.html#p3">m_Height</a> - btnHeight - border;
<a name="l01539"></a>01539 
<a name="l01540"></a>01540         buttonFlags &amp;= 0xF;
<a name="l01541"></a>01541         <span class="keywordflow">if</span> ( (buttonFlags == MB_ABORTRETRYIGNORE) ||
<a name="l01542"></a>01542                  (buttonFlags == MB_CANCELTRYCONTINUE) )
<a name="l01543"></a>01543 
<a name="l01544"></a>01544         {
<a name="l01545"></a>01545                 <span class="comment">// The message box contains three push buttons: Cancel, Try Again, Continue. </span>
<a name="l01546"></a>01546                 <span class="comment">// This is the new standard over Abort,Retry,Ignore</span>
<a name="l01547"></a>01547                 <a class="code" href="class_c_message_box.html#p0">m_UI</a>.<a class="code" href="class_c_d_x_u_t_dialog.html#a5">AddButton</a>( IDCONTINUE, g_pApp-&gt;<a class="code" href="class_game_code_app.html#a17">GetString</a>(<a class="code" href="_strings_8h.html#a11">IDS_CONTINUE</a>).c_str(), iX, iY - (2*border), btnWidth, btnHeight );
<a name="l01548"></a>01548                 <a class="code" href="class_c_message_box.html#p0">m_UI</a>.<a class="code" href="class_c_d_x_u_t_dialog.html#a5">AddButton</a>( IDTRYAGAIN, g_pApp-&gt;<a class="code" href="class_game_code_app.html#a17">GetString</a>(<a class="code" href="_strings_8h.html#a9">IDS_TRYAGAIN</a>).c_str(), iX, iY - border, btnWidth, btnHeight );
<a name="l01549"></a>01549                 <a class="code" href="class_c_message_box.html#p0">m_UI</a>.<a class="code" href="class_c_d_x_u_t_dialog.html#a5">AddButton</a>( IDCANCEL, g_pApp-&gt;<a class="code" href="class_game_code_app.html#a17">GetString</a>(<a class="code" href="_strings_8h.html#a10">IDS_CANCEL</a>).c_str(), iX, iY, btnWidth, btnHeight );
<a name="l01550"></a>01550         }
<a name="l01551"></a>01551         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buttonFlags == MB_OKCANCEL)
<a name="l01552"></a>01552         {
<a name="l01553"></a>01553                 <span class="comment">//The message box contains two push buttons: OK and Cancel.</span>
<a name="l01554"></a>01554                 <a class="code" href="class_c_message_box.html#p0">m_UI</a>.<a class="code" href="class_c_d_x_u_t_dialog.html#a5">AddButton</a>( IDOK, g_pApp-&gt;<a class="code" href="class_game_code_app.html#a17">GetString</a>(<a class="code" href="_strings_8h.html#a6">IDS_OK</a>).c_str(), iX, iY - border, btnWidth, btnHeight );
<a name="l01555"></a>01555                 <a class="code" href="class_c_message_box.html#p0">m_UI</a>.<a class="code" href="class_c_d_x_u_t_dialog.html#a5">AddButton</a>( IDCANCEL, g_pApp-&gt;<a class="code" href="class_game_code_app.html#a17">GetString</a>(<a class="code" href="_strings_8h.html#a10">IDS_CANCEL</a>).c_str(), iX, iY, btnWidth, btnHeight );
<a name="l01556"></a>01556         }
<a name="l01557"></a>01557         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buttonFlags == MB_RETRYCANCEL)
<a name="l01558"></a>01558         {
<a name="l01559"></a>01559                 <span class="comment">//The message box contains two push buttons: Retry and Cancel.</span>
<a name="l01560"></a>01560                 <a class="code" href="class_c_message_box.html#p0">m_UI</a>.<a class="code" href="class_c_d_x_u_t_dialog.html#a5">AddButton</a>( IDRETRY, g_pApp-&gt;<a class="code" href="class_game_code_app.html#a17">GetString</a>(<a class="code" href="_strings_8h.html#a12">IDS_RETRY</a>).c_str(), iX, iY - border, btnWidth, btnHeight );
<a name="l01561"></a>01561                 <a class="code" href="class_c_message_box.html#p0">m_UI</a>.<a class="code" href="class_c_d_x_u_t_dialog.html#a5">AddButton</a>( IDCANCEL, g_pApp-&gt;<a class="code" href="class_game_code_app.html#a17">GetString</a>(<a class="code" href="_strings_8h.html#a10">IDS_CANCEL</a>).c_str(), iX, iY, btnWidth, btnHeight );
<a name="l01562"></a>01562         }
<a name="l01563"></a>01563         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buttonFlags == MB_YESNO)
<a name="l01564"></a>01564         {
<a name="l01565"></a>01565                 <span class="comment">//The message box contains two push buttons: Yes and No.</span>
<a name="l01566"></a>01566                 <a class="code" href="class_c_message_box.html#p0">m_UI</a>.<a class="code" href="class_c_d_x_u_t_dialog.html#a5">AddButton</a>( IDYES, g_pApp-&gt;<a class="code" href="class_game_code_app.html#a17">GetString</a>(<a class="code" href="_strings_8h.html#a7">IDS_YES</a>).c_str(), iX, iY - border, btnWidth, btnHeight );
<a name="l01567"></a>01567                 <a class="code" href="class_c_message_box.html#p0">m_UI</a>.<a class="code" href="class_c_d_x_u_t_dialog.html#a5">AddButton</a>( IDNO, g_pApp-&gt;<a class="code" href="class_game_code_app.html#a17">GetString</a>(<a class="code" href="_strings_8h.html#a8">IDS_NO</a>).c_str(), iX, iY, btnWidth, btnHeight );
<a name="l01568"></a>01568         }
<a name="l01569"></a>01569         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buttonFlags == MB_YESNOCANCEL)
<a name="l01570"></a>01570         {
<a name="l01571"></a>01571                 <span class="comment">//The message box contains three push buttons: Yes, No, and Cancel.</span>
<a name="l01572"></a>01572                 <a class="code" href="class_c_message_box.html#p0">m_UI</a>.<a class="code" href="class_c_d_x_u_t_dialog.html#a5">AddButton</a>( IDYES, g_pApp-&gt;<a class="code" href="class_game_code_app.html#a17">GetString</a>(<a class="code" href="_strings_8h.html#a7">IDS_YES</a>).c_str(), iX, iY - (2*border), btnWidth, btnHeight );
<a name="l01573"></a>01573                 <a class="code" href="class_c_message_box.html#p0">m_UI</a>.<a class="code" href="class_c_d_x_u_t_dialog.html#a5">AddButton</a>( IDNO, g_pApp-&gt;<a class="code" href="class_game_code_app.html#a17">GetString</a>(<a class="code" href="_strings_8h.html#a8">IDS_NO</a>).c_str(), iX, iY - border, btnWidth, btnHeight );
<a name="l01574"></a>01574                 <a class="code" href="class_c_message_box.html#p0">m_UI</a>.<a class="code" href="class_c_d_x_u_t_dialog.html#a5">AddButton</a>( IDCANCEL, g_pApp-&gt;<a class="code" href="class_game_code_app.html#a17">GetString</a>(<a class="code" href="_strings_8h.html#a10">IDS_CANCEL</a>).c_str(), iX, iY, btnWidth, btnHeight );
<a name="l01575"></a>01575         }
<a name="l01576"></a>01576         <span class="keywordflow">else</span> <span class="comment">//if (buttonFlags &amp; MB_OK)</span>
<a name="l01577"></a>01577         {
<a name="l01578"></a>01578         <span class="comment">// The message box contains one push button: OK. This is the default.</span>
<a name="l01579"></a>01579                 <a class="code" href="class_c_message_box.html#p0">m_UI</a>.<a class="code" href="class_c_d_x_u_t_dialog.html#a5">AddButton</a>( IDOK, g_pApp-&gt;<a class="code" href="class_game_code_app.html#a17">GetString</a>(<a class="code" href="_strings_8h.html#a6">IDS_OK</a>).c_str(), iX, iY, btnWidth, btnHeight );
<a name="l01580"></a>01580         }
<a name="l01581"></a>01581 }
<a name="l01582"></a>01582 
<a name="l01583"></a>01583 <span class="comment">//</span>
<a name="l01584"></a>01584 <span class="comment">// class CMessageBox::VOnRestore  - Chapter 9, page 275</span>
<a name="l01585"></a>01585 <span class="comment">//</span>
<a name="l01586"></a><a class="code" href="class_c_message_box.html#a1">01586</a> <a class="code" href="_d_x_u_tgui_8cpp.html#a51">HRESULT</a> <a class="code" href="class_c_message_box.html#a1">CMessageBox::VOnRestore</a>()
<a name="l01587"></a>01587 {
<a name="l01588"></a>01588     <a class="code" href="class_c_message_box.html#p0">m_UI</a>.<a class="code" href="class_c_d_x_u_t_dialog.html#a51">SetLocation</a>( <a class="code" href="class_c_base_u_i.html#p0">m_PosX</a>, <a class="code" href="class_c_base_u_i.html#p1">m_PosY</a> );
<a name="l01589"></a>01589     <a class="code" href="class_c_message_box.html#p0">m_UI</a>.<a class="code" href="class_c_d_x_u_t_dialog.html#a52">SetSize</a>( <a class="code" href="class_c_base_u_i.html#p2">m_Width</a>, <a class="code" href="class_c_base_u_i.html#p3">m_Height</a> );
<a name="l01590"></a>01590         <span class="keywordflow">return</span> S_OK;
<a name="l01591"></a>01591 }
<a name="l01592"></a>01592 
<a name="l01593"></a>01593 
<a name="l01594"></a>01594 <span class="comment">//</span>
<a name="l01595"></a>01595 <span class="comment">// class CMessageBox::VOnRender - Chapter 9, page 275</span>
<a name="l01596"></a>01596 <span class="comment">//</span>
<a name="l01597"></a><a class="code" href="class_c_message_box.html#a2">01597</a> <a class="code" href="_d_x_u_tgui_8cpp.html#a51">HRESULT</a> <a class="code" href="class_c_message_box.html#a2">CMessageBox::VOnRender</a>(<span class="keywordtype">double</span> fTime, <span class="keywordtype">float</span> fElapsedTime)
<a name="l01598"></a>01598 {
<a name="l01599"></a>01599         <a class="code" href="_d_x_u_tgui_8cpp.html#a51">HRESULT</a> hr;
<a name="l01600"></a>01600         <a class="code" href="dxstdafx_8h.html#a5">V</a>( <a class="code" href="class_c_message_box.html#p0">m_UI</a>.<a class="code" href="class_c_d_x_u_t_dialog.html#a62">OnRender</a>( fElapsedTime ) );
<a name="l01601"></a>01601         <span class="keywordflow">return</span> S_OK;
<a name="l01602"></a>01602 };
<a name="l01603"></a>01603 
<a name="l01604"></a>01604 
<a name="l01605"></a>01605 <span class="comment">//</span>
<a name="l01606"></a>01606 <span class="comment">// class CMessageBox::VOnMsgProc - Chapter 9, page 276</span>
<a name="l01607"></a>01607 <span class="comment">//</span>
<a name="l01608"></a><a class="code" href="class_c_message_box.html#a5">01608</a> LRESULT CALLBACK <a class="code" href="class_c_message_box.html#a5">CMessageBox::VOnMsgProc</a>( <a class="code" href="struct_app_msg.html">AppMsg</a> msg )
<a name="l01609"></a>01609 {
<a name="l01610"></a>01610     <span class="keywordflow">return</span> <a class="code" href="class_c_message_box.html#p0">m_UI</a>.<a class="code" href="class_c_d_x_u_t_dialog.html#a3">MsgProc</a>( msg.<a class="code" href="struct_app_msg.html#o0">m_hWnd</a>, msg.<a class="code" href="struct_app_msg.html#o1">m_uMsg</a>, msg.<a class="code" href="struct_app_msg.html#o2">m_wParam</a>, msg.<a class="code" href="struct_app_msg.html#o3">m_lParam</a> );
<a name="l01611"></a>01611 }
<a name="l01612"></a>01612 
<a name="l01613"></a>01613 
<a name="l01614"></a>01614 
<a name="l01615"></a>01615 <span class="comment">//</span>
<a name="l01616"></a>01616 <span class="comment">// HumanView::HumanView - Chapter 9, page 261</span>
<a name="l01617"></a>01617 <span class="comment">//</span>
<a name="l01618"></a><a class="code" href="class_human_view.html#a11">01618</a> <a class="code" href="class_human_view.html#a11">HumanView::HumanView</a>()
<a name="l01619"></a>01619 {
<a name="l01620"></a>01620         <a class="code" href="class_human_view.html#a12">InitAudio</a>(); 
<a name="l01621"></a>01621 
<a name="l01622"></a>01622         <a class="code" href="class_human_view.html#p2">m_pProcessManager</a> = <a class="code" href="_game_code_std_8h.html#a2">GCC_NEW</a> <a class="code" href="class_c_process_manager.html">CProcessManager</a>;
<a name="l01623"></a>01623 
<a name="l01624"></a>01624         <a class="code" href="class_human_view.html#p6">m_pFont</a> = NULL;         <span class="comment">// Font for drawing text</span>
<a name="l01625"></a>01625         <a class="code" href="class_human_view.html#p7">m_pTextSprite</a> = NULL;   <span class="comment">// Sprite for batching draw text calls</span>
<a name="l01626"></a>01626 }
<a name="l01627"></a>01627 
<a name="l01628"></a>01628 
<a name="l01629"></a>01629 <span class="comment">//</span>
<a name="l01630"></a>01630 <span class="comment">// HumanView::~HumanView - Chapter 9, page 262</span>
<a name="l01631"></a>01631 <span class="comment">//</span>
<a name="l01632"></a>01632 
<a name="l01633"></a><a class="code" href="class_human_view.html#a10">01633</a> <a class="code" href="class_human_view.html#a10">HumanView::~HumanView</a>()
<a name="l01634"></a>01634 {
<a name="l01635"></a>01635         <span class="keywordflow">while</span> (!<a class="code" href="class_human_view.html#o0">m_ScreenElements</a>.empty())
<a name="l01636"></a>01636         {
<a name="l01637"></a>01637                 ScreenElementList::iterator i=<a class="code" href="class_human_view.html#o0">m_ScreenElements</a>.begin(); 
<a name="l01638"></a>01638                 <a class="code" href="class_human_view.html#o0">m_ScreenElements</a>.pop_front();           
<a name="l01639"></a>01639         }
<a name="l01640"></a>01640 
<a name="l01641"></a>01641     <a class="code" href="dxstdafx_8h.html#a9">SAFE_RELEASE</a>( <a class="code" href="class_human_view.html#p7">m_pTextSprite</a> );
<a name="l01642"></a>01642         <a class="code" href="dxstdafx_8h.html#a9">SAFE_RELEASE</a>( <a class="code" href="class_human_view.html#p6">m_pFont</a> );
<a name="l01643"></a>01643 
<a name="l01644"></a>01644         <a class="code" href="class_human_view.html#p2">m_pProcessManager</a>-&gt;<a class="code" href="class_c_process_manager.html#a1">DeleteProcessList</a>();
<a name="l01645"></a>01645         <a class="code" href="dxstdafx_8h.html#a7">SAFE_DELETE</a>(<a class="code" href="class_human_view.html#p2">m_pProcessManager</a>);
<a name="l01646"></a>01646 
<a name="l01647"></a>01647         <span class="keywordflow">if</span> (<a class="code" href="_c_audio_8cpp.html#a0">g_Audio</a>) <a class="code" href="_c_audio_8cpp.html#a0">g_Audio</a>-&gt;<a class="code" href="class_c_audio.html#a4">VShutdown</a>();
<a name="l01648"></a>01648         <a class="code" href="dxstdafx_8h.html#a7">SAFE_DELETE</a>(<a class="code" href="_c_audio_8cpp.html#a0">g_Audio</a>);
<a name="l01649"></a>01649 }
<a name="l01650"></a>01650 
<a name="l01651"></a>01651 
<a name="l01652"></a>01652 <span class="comment">//</span>
<a name="l01653"></a>01653 <span class="comment">// HumanView::VOnRender - Chapter 9, page 262</span>
<a name="l01654"></a>01654 <span class="comment">//</span>
<a name="l01655"></a>01655 
<a name="l01656"></a><a class="code" href="class_human_view.html#a1">01656</a> <span class="keywordtype">void</span> <a class="code" href="class_human_view.html#a1">HumanView::VOnRender</a>(<span class="keywordtype">double</span> fTime, <span class="keywordtype">float</span> fElapsedTime )
<a name="l01657"></a>01657 {
<a name="l01658"></a>01658         <a class="code" href="class_human_view.html#p3">m_currTick</a> = timeGetTime();
<a name="l01659"></a>01659         <span class="keywordflow">if</span> (<a class="code" href="class_human_view.html#p3">m_currTick</a> == <a class="code" href="class_human_view.html#p4">m_lastDraw</a>)
<a name="l01660"></a>01660                 <span class="keywordflow">return</span>;
<a name="l01661"></a>01661 
<a name="l01662"></a>01662         <a class="code" href="_d_x_u_tgui_8cpp.html#a51">HRESULT</a> hr;
<a name="l01663"></a>01663 
<a name="l01664"></a>01664         <span class="comment">// It is time to draw ?</span>
<a name="l01665"></a>01665         <span class="keywordflow">if</span>( <a class="code" href="class_human_view.html#p5">m_runFullSpeed</a> || ( (<a class="code" href="class_human_view.html#p3">m_currTick</a> - <a class="code" href="class_human_view.html#p4">m_lastDraw</a>) &gt; <a class="code" href="_game_code_8cpp.html#a3">SCREEN_REFRESH_RATE</a>) )
<a name="l01666"></a>01666         {
<a name="l01667"></a>01667             <span class="comment">// Clear the render target and the zbuffer </span>
<a name="l01668"></a>01668                 <a class="code" href="dxstdafx_8h.html#a5">V</a>( <a class="code" href="_d_x_u_t_8cpp.html#a94">DXUTGetD3DDevice</a>()-&gt;Clear(0, NULL, D3DCLEAR_TARGET | D3DCLEAR_ZBUFFER, D3DCOLOR_ARGB(0, 45, 50, 170), 1.0f, 0) );
<a name="l01669"></a>01669 
<a name="l01670"></a>01670 
<a name="l01671"></a>01671             <span class="comment">// Render the scene</span>
<a name="l01672"></a>01672                 <span class="keywordflow">if</span>( SUCCEEDED( <a class="code" href="_d_x_u_t_8cpp.html#a94">DXUTGetD3DDevice</a>()-&gt;BeginScene() ) )
<a name="l01673"></a>01673                 {
<a name="l01674"></a>01674                         <span class="comment">// The helper object simply helps keep track of text position, and color</span>
<a name="l01675"></a>01675                         <span class="comment">// and then it calls pFont-&gt;DrawText( m_pSprite, strMsg, -1, &amp;rc, DT_NOCLIP, m_clr );</span>
<a name="l01676"></a>01676                         <span class="comment">// If NULL is passed in as the sprite object, then it will work however the </span>
<a name="l01677"></a>01677                         <span class="comment">// pFont-&gt;DrawText() will not be batched together.  Batching calls will improves performance.</span>
<a name="l01678"></a>01678 
<a name="l01679"></a>01679                         <a class="code" href="class_c_d_x_u_t_text_helper.html">CDXUTTextHelper</a> txtHelper( <a class="code" href="class_human_view.html#p6">m_pFont</a>, <a class="code" href="class_human_view.html#p7">m_pTextSprite</a>, 15 );                        
<a name="l01680"></a>01680                         <a class="code" href="class_human_view.html#b0">VRenderText</a>(txtHelper);
<a name="l01681"></a>01681 
<a name="l01682"></a>01682                         <a class="code" href="class_human_view.html#o0">m_ScreenElements</a>.sort();
<a name="l01683"></a>01683                         <span class="keywordflow">for</span>(ScreenElementList::iterator i=<a class="code" href="class_human_view.html#o0">m_ScreenElements</a>.begin(); i!=<a class="code" href="class_human_view.html#o0">m_ScreenElements</a>.end(); ++i)
<a name="l01684"></a>01684                         {
<a name="l01685"></a>01685                                 <span class="keywordflow">if</span> ( (*i)-&gt;VIsVisible() )
<a name="l01686"></a>01686                                 {
<a name="l01687"></a>01687                                         (*i)-&gt;VOnRender(fTime, fElapsedTime);
<a name="l01688"></a>01688                                 }
<a name="l01689"></a>01689                         }
<a name="l01690"></a>01690 
<a name="l01691"></a>01691                         <span class="comment">// record the last successful paint</span>
<a name="l01692"></a>01692                         <a class="code" href="class_human_view.html#p4">m_lastDraw</a> = <a class="code" href="class_human_view.html#p3">m_currTick</a>;
<a name="l01693"></a>01693                 }
<a name="l01694"></a>01694 
<a name="l01695"></a>01695         <a class="code" href="dxstdafx_8h.html#a5">V</a>( <a class="code" href="_d_x_u_t_8cpp.html#a94">DXUTGetD3DDevice</a>()-&gt;EndScene() );
<a name="l01696"></a>01696     }
<a name="l01697"></a>01697 }
<a name="l01698"></a>01698 
<a name="l01699"></a>01699 <span class="comment">//</span>
<a name="l01700"></a>01700 <span class="comment">// HumanView::VOnRestore - Chapter 9, page 264</span>
<a name="l01701"></a>01701 <span class="comment">//</span>
<a name="l01702"></a><a class="code" href="class_human_view.html#a0">01702</a> <a class="code" href="_d_x_u_tgui_8cpp.html#a51">HRESULT</a> <a class="code" href="class_human_view.html#a0">HumanView::VOnRestore</a>()
<a name="l01703"></a>01703 {
<a name="l01704"></a>01704         <a class="code" href="_d_x_u_tgui_8cpp.html#a51">HRESULT</a> hr = S_OK;
<a name="l01705"></a>01705 
<a name="l01706"></a>01706     <span class="keywordflow">if</span>( !<a class="code" href="class_human_view.html#p6">m_pFont</a> )
<a name="l01707"></a>01707         {
<a name="l01708"></a>01708             <span class="comment">// Initialize the font</span>
<a name="l01709"></a>01709             D3DXCreateFont( <a class="code" href="_d_x_u_t_8cpp.html#a94">DXUTGetD3DDevice</a>(), 15, 0, FW_BOLD, 1, FALSE, DEFAULT_CHARSET, 
<a name="l01710"></a>01710                          OUT_DEFAULT_PRECIS, DEFAULT_QUALITY, DEFAULT_PITCH | FF_DONTCARE, 
<a name="l01711"></a>01711                          L<span class="stringliteral">"Arial"</span>, &amp;<a class="code" href="class_human_view.html#p6">m_pFont</a> );
<a name="l01712"></a>01712         }
<a name="l01713"></a>01713         <span class="keywordflow">else</span>
<a name="l01714"></a>01714         {
<a name="l01715"></a>01715         <a class="code" href="dxstdafx_8h.html#a6">V_RETURN</a>( <a class="code" href="class_human_view.html#p6">m_pFont</a>-&gt;OnResetDevice() );
<a name="l01716"></a>01716         }
<a name="l01717"></a>01717 
<a name="l01718"></a>01718         <span class="keywordflow">if</span> (!<a class="code" href="class_human_view.html#p7">m_pTextSprite</a>)
<a name="l01719"></a>01719         {
<a name="l01720"></a>01720                 <span class="comment">// Create a sprite to help batch calls when drawing many lines of text</span>
<a name="l01721"></a>01721                 <a class="code" href="dxstdafx_8h.html#a6">V_RETURN</a>( D3DXCreateSprite( <a class="code" href="_d_x_u_t_8cpp.html#a94">DXUTGetD3DDevice</a>(), &amp;<a class="code" href="class_human_view.html#p7">m_pTextSprite</a> ) );
<a name="l01722"></a>01722         }
<a name="l01723"></a>01723         <span class="keywordflow">else</span>
<a name="l01724"></a>01724         {
<a name="l01725"></a>01725         <a class="code" href="dxstdafx_8h.html#a6">V_RETURN</a>( <a class="code" href="class_human_view.html#p7">m_pTextSprite</a>-&gt;OnResetDevice() );             
<a name="l01726"></a>01726         }
<a name="l01727"></a>01727         
<a name="l01728"></a>01728         <span class="keywordflow">for</span>(ScreenElementList::iterator i=<a class="code" href="class_human_view.html#o0">m_ScreenElements</a>.begin(); i!=<a class="code" href="class_human_view.html#o0">m_ScreenElements</a>.end(); ++i)
<a name="l01729"></a>01729         {
<a name="l01730"></a>01730                 <a class="code" href="dxstdafx_8h.html#a6">V_RETURN</a> ( (*i)-&gt;VOnRestore() );
<a name="l01731"></a>01731         }
<a name="l01732"></a>01732 
<a name="l01733"></a>01733         <span class="keywordflow">return</span> hr;
<a name="l01734"></a>01734 }
<a name="l01735"></a>01735 
<a name="l01736"></a>01736 
<a name="l01737"></a>01737 <span class="comment">//</span>
<a name="l01738"></a>01738 <span class="comment">// HumanView::VOnLostDevice - Chapter 9, page TODO</span>
<a name="l01739"></a>01739 <span class="comment">//</span>
<a name="l01740"></a><a class="code" href="class_human_view.html#a2">01740</a> <span class="keywordtype">void</span> <a class="code" href="class_human_view.html#a2">HumanView::VOnLostDevice</a>() 
<a name="l01741"></a>01741 {
<a name="l01742"></a>01742         <span class="keywordflow">if</span>( <a class="code" href="class_human_view.html#p6">m_pFont</a> )
<a name="l01743"></a>01743         <a class="code" href="class_human_view.html#p6">m_pFont</a>-&gt;OnLostDevice();
<a name="l01744"></a>01744     <span class="comment">//if( g_pEffect )</span>
<a name="l01745"></a>01745     <span class="comment">//    g_pEffect-&gt;OnLostDevice();</span>
<a name="l01746"></a>01746     <a class="code" href="dxstdafx_8h.html#a9">SAFE_RELEASE</a>( <a class="code" href="class_human_view.html#p7">m_pTextSprite</a> );
<a name="l01747"></a>01747 }
<a name="l01748"></a>01748 
<a name="l01749"></a>01749 
<a name="l01750"></a>01750 
<a name="l01751"></a>01751 <span class="comment">//</span>
<a name="l01752"></a>01752 <span class="comment">// HumanView::InitAudio - Chapter 9, page 264</span>
<a name="l01753"></a>01753 <span class="comment">//</span>
<a name="l01754"></a><a class="code" href="class_human_view.html#a12">01754</a> <span class="keywordtype">bool</span> <a class="code" href="class_human_view.html#a12">HumanView::InitAudio</a>()
<a name="l01755"></a>01755 {
<a name="l01756"></a>01756         <a class="code" href="dxstdafx_8h.html#a7">SAFE_DELETE</a>(<a class="code" href="_c_audio_8cpp.html#a0">g_Audio</a>);
<a name="l01757"></a>01757         <a class="code" href="_c_audio_8cpp.html#a0">g_Audio</a> = <a class="code" href="_game_code_std_8h.html#a2">GCC_NEW</a> <a class="code" href="class_c_direct_sound_audio.html">CDirectSoundAudio</a>();          <span class="comment">// use this line for DirectSound</span>
<a name="l01758"></a>01758         <span class="comment">//g_Audio = GCC_NEW CMilesAudio();                      // use this line for Miles Audio</span>
<a name="l01759"></a>01759 
<a name="l01760"></a>01760         <span class="keywordflow">if</span> (!<a class="code" href="_c_audio_8cpp.html#a0">g_Audio</a>)
<a name="l01761"></a>01761                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01762"></a>01762 
<a name="l01763"></a>01763         <span class="keywordflow">if</span> (!<a class="code" href="_c_audio_8cpp.html#a0">g_Audio</a>-&gt;<a class="code" href="class_i_audio.html#a6">VInitialize</a>(g_pApp-&gt;<a class="code" href="class_game_code_app.html#a4">GetHwnd</a>()))
<a name="l01764"></a>01764                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01765"></a>01765 
<a name="l01766"></a>01766         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01767"></a>01767 }
<a name="l01768"></a>01768 
<a name="l01769"></a>01769 
<a name="l01770"></a>01770 <span class="comment">//</span>
<a name="l01771"></a>01771 <span class="comment">// HumanView::VOnMsgProc - Chapter 9, page 266</span>
<a name="l01772"></a>01772 <span class="comment">//</span>
<a name="l01773"></a><a class="code" href="class_human_view.html#a8">01773</a> LRESULT CALLBACK <a class="code" href="class_human_view.html#a8">HumanView::VOnMsgProc</a>( <a class="code" href="struct_app_msg.html">AppMsg</a> msg )
<a name="l01774"></a>01774 {
<a name="l01775"></a>01775         <span class="comment">// Iterate through the screen layers first</span>
<a name="l01776"></a>01776         <span class="comment">// In reverse order since we'll send input messages to the </span>
<a name="l01777"></a>01777         <span class="comment">// screen on top</span>
<a name="l01778"></a>01778         <span class="keywordflow">for</span>(ScreenElementList::reverse_iterator i=<a class="code" href="class_human_view.html#o0">m_ScreenElements</a>.rbegin(); i!=<a class="code" href="class_human_view.html#o0">m_ScreenElements</a>.rend(); ++i)
<a name="l01779"></a>01779         {
<a name="l01780"></a>01780                 <span class="keywordflow">if</span> ( (*i)-&gt;VIsVisible() )
<a name="l01781"></a>01781                 {
<a name="l01782"></a>01782                         <span class="keywordflow">if</span> ( (*i)-&gt;VOnMsgProc( msg ) )
<a name="l01783"></a>01783                         {
<a name="l01784"></a>01784                                 <span class="keywordflow">return</span> 1;
<a name="l01785"></a>01785                         }
<a name="l01786"></a>01786                 }
<a name="l01787"></a>01787         }
<a name="l01788"></a>01788 
<a name="l01789"></a>01789         LRESULT result = 0;
<a name="l01790"></a>01790         <span class="keywordflow">switch</span> (msg.<a class="code" href="struct_app_msg.html#o1">m_uMsg</a>) 
<a name="l01791"></a>01791         {
<a name="l01792"></a>01792         <span class="keywordflow">case</span> WM_KEYDOWN:
<a name="l01793"></a>01793                         <span class="keywordflow">if</span> (<a class="code" href="class_human_view.html#o2">m_KeyboardHandler</a>)
<a name="l01794"></a>01794                                 result = <a class="code" href="class_human_view.html#o2">m_KeyboardHandler</a>-&gt;VOnKeyDown(static_cast&lt;const BYTE&gt;(msg.<a class="code" href="struct_app_msg.html#o2">m_wParam</a>));
<a name="l01795"></a>01795                         <span class="keywordflow">break</span>;
<a name="l01796"></a>01796         
<a name="l01797"></a>01797         <span class="keywordflow">case</span> WM_KEYUP:
<a name="l01798"></a>01798                         <span class="keywordflow">if</span> (<a class="code" href="class_human_view.html#o2">m_KeyboardHandler</a>)
<a name="l01799"></a>01799                                 result = <a class="code" href="class_human_view.html#o2">m_KeyboardHandler</a>-&gt;VOnKeyUp(static_cast&lt;const BYTE&gt;(msg.<a class="code" href="struct_app_msg.html#o2">m_wParam</a>));
<a name="l01800"></a>01800                         <span class="keywordflow">break</span>;
<a name="l01801"></a>01801 
<a name="l01802"></a>01802                 <span class="keywordflow">case</span> WM_MOUSEMOVE:
<a name="l01803"></a>01803                         <span class="keywordflow">if</span> (<a class="code" href="class_human_view.html#o1">m_MouseHandler</a>)
<a name="l01804"></a>01804                                 result = <a class="code" href="class_human_view.html#o1">m_MouseHandler</a>-&gt;VOnMouseMove(CPoint(LOWORD(msg.<a class="code" href="struct_app_msg.html#o3">m_lParam</a>), HIWORD(msg.<a class="code" href="struct_app_msg.html#o3">m_lParam</a>)));
<a name="l01805"></a>01805                         <span class="keywordflow">break</span>;
<a name="l01806"></a>01806 
<a name="l01807"></a>01807                 <span class="keywordflow">case</span> WM_LBUTTONDOWN:
<a name="l01808"></a>01808                         <span class="keywordflow">if</span> (<a class="code" href="class_human_view.html#o1">m_MouseHandler</a>)
<a name="l01809"></a>01809                         {
<a name="l01810"></a>01810                                 SetCapture(msg.<a class="code" href="struct_app_msg.html#o0">m_hWnd</a>);
<a name="l01811"></a>01811                                 result = <a class="code" href="class_human_view.html#o1">m_MouseHandler</a>-&gt;VOnLButtonDown(CPoint(LOWORD(msg.<a class="code" href="struct_app_msg.html#o3">m_lParam</a>), HIWORD(msg.<a class="code" href="struct_app_msg.html#o3">m_lParam</a>)));
<a name="l01812"></a>01812                         }       
<a name="l01813"></a>01813                         <span class="keywordflow">break</span>;
<a name="l01814"></a>01814 
<a name="l01815"></a>01815                 <span class="keywordflow">case</span> WM_LBUTTONUP:
<a name="l01816"></a>01816                         <span class="keywordflow">if</span> (<a class="code" href="class_human_view.html#o1">m_MouseHandler</a>)
<a name="l01817"></a>01817                         {
<a name="l01818"></a>01818                                 SetCapture(NULL);
<a name="l01819"></a>01819                                 result = <a class="code" href="class_human_view.html#o1">m_MouseHandler</a>-&gt;VOnLButtonUp(CPoint(LOWORD(msg.<a class="code" href="struct_app_msg.html#o3">m_lParam</a>), HIWORD(msg.<a class="code" href="struct_app_msg.html#o3">m_lParam</a>)));
<a name="l01820"></a>01820                         }
<a name="l01821"></a>01821                         <span class="keywordflow">break</span>;
<a name="l01822"></a>01822 
<a name="l01823"></a>01823                 <span class="keywordflow">case</span> WM_RBUTTONDOWN:
<a name="l01824"></a>01824                         <span class="keywordflow">if</span> (<a class="code" href="class_human_view.html#o1">m_MouseHandler</a>)
<a name="l01825"></a>01825                         {
<a name="l01826"></a>01826                                 SetCapture(msg.<a class="code" href="struct_app_msg.html#o0">m_hWnd</a>);
<a name="l01827"></a>01827                                 result = <a class="code" href="class_human_view.html#o1">m_MouseHandler</a>-&gt;VOnRButtonDown(CPoint(LOWORD(msg.<a class="code" href="struct_app_msg.html#o3">m_lParam</a>), HIWORD(msg.<a class="code" href="struct_app_msg.html#o3">m_lParam</a>)));
<a name="l01828"></a>01828                         }
<a name="l01829"></a>01829                         <span class="keywordflow">break</span>;
<a name="l01830"></a>01830 
<a name="l01831"></a>01831                 <span class="keywordflow">case</span> WM_RBUTTONUP:
<a name="l01832"></a>01832                         <span class="keywordflow">if</span> (<a class="code" href="class_human_view.html#o1">m_MouseHandler</a>)
<a name="l01833"></a>01833                         {
<a name="l01834"></a>01834                                 SetCapture(NULL);
<a name="l01835"></a>01835                                 result = <a class="code" href="class_human_view.html#o1">m_MouseHandler</a>-&gt;VOnRButtonUp(CPoint(LOWORD(msg.<a class="code" href="struct_app_msg.html#o3">m_lParam</a>), HIWORD(msg.<a class="code" href="struct_app_msg.html#o3">m_lParam</a>)));
<a name="l01836"></a>01836                         }
<a name="l01837"></a>01837                         <span class="keywordflow">break</span>;
<a name="l01838"></a>01838 
<a name="l01839"></a>01839                 <span class="keywordflow">default</span>:
<a name="l01840"></a>01840                         <span class="keywordflow">return</span> 0;
<a name="l01841"></a>01841         }
<a name="l01842"></a>01842 
<a name="l01843"></a>01843         <span class="keywordflow">return</span> 0;
<a name="l01844"></a>01844 }
<a name="l01845"></a>01845 
<a name="l01846"></a>01846 <span class="comment">//</span>
<a name="l01847"></a>01847 <span class="comment">// HumanView::VOnRestore - Chapter 9, page 265</span>
<a name="l01848"></a>01848 <span class="comment">//</span>
<a name="l01849"></a><a class="code" href="class_human_view.html#a9">01849</a> <span class="keywordtype">void</span> <a class="code" href="class_human_view.html#a9">HumanView::VOnUpdate</a>( <span class="keywordtype">int</span> deltaMilliseconds )
<a name="l01850"></a>01850 {
<a name="l01851"></a>01851         <a class="code" href="class_human_view.html#p2">m_pProcessManager</a>-&gt;<a class="code" href="class_c_process_manager.html#a0">UpdateProcesses</a>(deltaMilliseconds);
<a name="l01852"></a>01852 
<a name="l01853"></a>01853         <span class="comment">// This section of code was added post-press. It runs through the screenlist</span>
<a name="l01854"></a>01854         <span class="comment">// and calls VOnUpdate. Some screen elements need to update every frame, one </span>
<a name="l01855"></a>01855         <span class="comment">// example of this is a 3D scene attached to the human view.</span>
<a name="l01856"></a>01856         <span class="comment">//</span>
<a name="l01857"></a>01857         <span class="keywordflow">for</span>(ScreenElementList::iterator i=<a class="code" href="class_human_view.html#o0">m_ScreenElements</a>.begin(); i!=<a class="code" href="class_human_view.html#o0">m_ScreenElements</a>.end(); ++i)
<a name="l01858"></a>01858         {
<a name="l01859"></a>01859                 (*i)-&gt;VOnUpdate(deltaMilliseconds);
<a name="l01860"></a>01860         }
<a name="l01861"></a>01861 }
<a name="l01862"></a>01862 
<a name="l01863"></a>01863 <span class="comment">//</span>
<a name="l01864"></a>01864 <span class="comment">// HumanView::VPushElement - Chapter 9, page 268</span>
<a name="l01865"></a>01865 <span class="comment">// (note - this was renamed from HumanView::VPushScreen)</span>
<a name="l01866"></a>01866 <span class="comment">//</span>
<a name="l01867"></a><a class="code" href="class_human_view.html#a6">01867</a> <span class="keywordtype">void</span> <a class="code" href="class_human_view.html#a6">HumanView::VPushElement</a>(shared_ptr&lt;IScreenElement&gt; pElement)
<a name="l01868"></a>01868 {
<a name="l01869"></a>01869         <a class="code" href="class_human_view.html#o0">m_ScreenElements</a>.push_back(pElement);
<a name="l01870"></a>01870 }
<a name="l01871"></a>01871 
<a name="l01872"></a>01872 <span class="comment">//</span>
<a name="l01873"></a>01873 <span class="comment">// HumanView::VPopElement - Chapter 9, page 268</span>
<a name="l01874"></a>01874 <span class="comment">// (note - this was renamed from HumanView::VPopScreen)</span>
<a name="l01875"></a>01875 <span class="comment">//</span>
<a name="l01876"></a><a class="code" href="class_human_view.html#a7">01876</a> <span class="keywordtype">void</span> <a class="code" href="class_human_view.html#a7">HumanView::VPopElement</a>()
<a name="l01877"></a>01877 {
<a name="l01878"></a>01878         <a class="code" href="class_human_view.html#o0">m_ScreenElements</a>.pop_back();
<a name="l01879"></a>01879 }
<a name="l01880"></a>01880 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Aug 22 14:08:18 2006 for GameCode by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.3 </small></address>
</body>
</html>
